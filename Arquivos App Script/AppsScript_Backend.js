// --- VERSÃO API: 1.5.8 (BitLocker Data & Search Fix) ---
const PROJECT_ID_API = 'maga-bigdata';

// ÚNICA PLANILHA DE GESTÃO
const ID_PLANILHA_GESTAO = '1Q13WpkiqRVjoniHT938JJlEdHqCFBYoywdXsDf2SIw8';

// Config email Admin
const EMAIL_ADMIN = "leandro.araujo@luizalabs.com";
const LOGO_BASE64 = 'data:image/png;base64,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'

function doGet(e) {
    // 1. ACTIONS & APPROVALS (Action via Email Link)
    if (e && e.parameter && e.parameter.action) {
        // Handle actions like 'finalizar', 'approve', 'reject'
        if (e.parameter.action === 'finalizar' && e.parameter.id) {
            return finalizarAtendimentoBitlocker(e.parameter.id, e.parameter.analista);
        }
        return handleApprovalAction(e);
    }

    // 2. API & DAEMON (Mode via URL)
    if (e && e.parameter && e.parameter.mode) {
        // v1.5.0: Lista Analistas Otimizada
        if (e.parameter.mode === 'get_analysts_api') {
            return ContentService.createTextOutput(JSON.stringify(getAnalystsListAPI())).setMimeType(ContentService.MimeType.JSON);
        }

        // Daemon v4 Main Queue (Reset & Mirror)
        if (e.parameter.mode === 'get_daemon_queue') {
            return handleUnifiedQueue();
        }

        // Legacy/Specific Checks
        if (e.parameter.mode === 'check_mirror_queue') {
            return ContentService.createTextOutput(handleMirrorQueueCheck()).setMimeType(ContentService.MimeType.JSON);
        }
        if (e.parameter.mode === 'get_analysts') {
            return ContentService.createTextOutput(JSON.stringify(getAnalystsList())).setMimeType(ContentService.MimeType.JSON);
        }
        if (e.parameter.mode === 'api') {
            return handlePowerShellQueueRequest();
        }
        if (e.parameter.mode === 'debug_full') {
            return ContentService.createTextOutput(debugSheetReader()).setMimeType(ContentService.MimeType.JSON);
        }

        // DEBUG TEMPORARIO: Estrutura da Planilha
        if (e.parameter.mode === 'debug_queue') {
            const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
            const sheet = ss.getSheetByName("Solicitações");
            const data = sheet.getDataRange().getDisplayValues();
            const headers = data[0];
            const lastRows = data.slice(-10).map((r, idx) => ({
                row_idx: data.length - 10 + idx + 1,
                id: r[0],
                nome: r[4],
                status_proc: r[9],
                status_aprov: r[10],
                tipo: r[11],
                raw: r
            }));
            return ContentService.createTextOutput(JSON.stringify({
                sheet_name: sheet.getName(),
                total_rows: data.length,
                headers: headers,
                last_items: lastRows
            })).setMimeType(ContentService.MimeType.JSON);
        }
    }

    // 3. WEB APP (INTERFACE PADRÃO COM LOGO)
    var tmp = HtmlService.createTemplateFromFile('AppsScript_Web_Index');
    tmp.LOGO_BASE64 = LOGO_BASE64; // Injeta a variável no template HTML
    return tmp.evaluate()
        .setTitle('Reset de Usuários - Suporte Infra CDs')
        .addMetaTag('viewport', 'width=device-width, initial-scale=1')
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// =========================================================================
// AUTH SYSTEM (Login, Senha, Token)
// =========================================================================

function getAuthSheet() {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    let sheet = ss.getSheetByName("AUTH");
    if (!sheet) {
        sheet = ss.insertSheet("AUTH");
        sheet.setTabColor("Red");
    }

    if (sheet.getLastRow() === 0) {
        sheet.appendRow(["ID_MAGALU", "NOME", "EMAIL", "SENHA_HASH", "SALT", "STATUS", "PRIMEIRO_ACESSO", "DATA_CRIACAO"]);
        sheet.getRange(1, 1, 1, 8).setFontWeight("bold").setBackground("#e6b8af");
    }
    return sheet;
}

function fetchUserByID(id) {
    if (!id) throw new Error("ID obrigatório");
    const sanID = String(id).replace(/\D/g, "");

    const sql = `
        SELECT t2.NOME, t1.email
        FROM \`maga-bigdata.kirk.assignee\` AS t1
        INNER JOIN \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` AS t2 
            ON t1.CUSTOM1 = CAST(t2.ID AS STRING)
        WHERE CAST(t2.ID AS STRING) = '${sanID}'
        AND t2.SITUACAO = 'Em Atividade Normal'
        LIMIT 1
    `;

    const rows = executeQueryBQ(sql);
    if (!rows || rows.length === 0) {
        throw new Error("ID não encontrado ou inativo no BigQuery.");
    }

    return {
        nome: rows[0][0],
        email: rows[0][1]
    };
}

// 2. LOGIN COM GOOGLE (NOVO)
function loginWithGoogle() {
    const email = Session.getActiveUser().getEmail();

    if (!email) {
        throw new Error("Não foi possível identificar sua conta Google. Certifique-se de dar permissão ao script.");
    }

    // 1. Validação de Domínio
    const allowedDomains = [
        "magazineluiza.com.br",
        "sode.com.br",
        "netshoes.com",
        "netshoes.com.br",
        "gfllogistica.com.br",
        "luizalabs.com"
    ];

    const domain = email.split("@")[1];
    if (!allowedDomains.includes(domain)) {
        throw new Error("Domínio não autorizado: " + domain);
    }

    // 2. Validação de Acesso (AUTH Sheet ou BigQuery)
    // Se estiver na planilha AUTH, ok. Mas queremos dados ricos do BigQuery também.

    let userDetails = null;
    try {
        userDetails = getUserDetails(email);
    } catch (e) {
        console.warn("Falha ao buscar detalhes no BQ para " + email + ": " + e.message);
    }

    // Se achou no BQ, usa dados do BQ. Se não, fallback para AUTH sheet (check simples)
    if (userDetails) {
        return {
            success: true,
            token: email,
            name: userDetails.nome || email.split("@")[0],
            email: email,
            filial: userDetails.filial,
            centro_custo: userDetails.centro_custo,
            cargo: userDetails.cargo
        };
    }

    // Fallback Sheet AUTH (Legado/Contingência)
    const sheet = getAuthSheet();
    const data = sheet.getDataRange().getValues();
    let userFound = false;
    let userName = "";

    for (let i = 1; i < data.length; i++) {
        if (String(data[i][2]).toLowerCase() === String(email).toLowerCase()) {
            if (String(data[i][5]) !== "ATIVO") {
                throw new Error("Usuário cadastrado mas não está ATIVO (Status: " + data[i][5] + ").");
            }
            userFound = true;
            userName = data[i][1];
            break;
        }
    }

    if (!userFound) {
        // Permitir acesso básico se for luizalabs (Auto-provisionamento light)
        if (domain === "luizalabs.com") {
            return { success: true, token: email, name: email.split("@")[0], email: email, filial: "MATRIZ", centro_custo: "" };
        }
        throw new Error("Usuário não cadastrado no sistema. Solicite acesso ao administrador.");
    }

    return {
        success: true,
        token: email,
        name: userName,
        email: email,
        filial: "",
        centro_custo: ""
    };
}

function getUserDetails(email) {
    if (!email) return null;
    // Ajuste conforme seu schema real no BigQuery
    const sql = `
        SELECT ID, NOME, FILIAL, CENTRO_CUSTO, CARGO 
        FROM \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\`
        WHERE EMAIL = '${email}'
        LIMIT 1
    `;
    const rows = executeQueryBQ(sql);
    if (!rows || rows.length === 0) return null;

    const r = rows[0]; // [ID, NOME, FILIAL, CENTRO_CUSTO, CARGO]
    return {
        id: r[0],
        nome: r[1],
        filial: r[2],
        centro_custo: r[3],
        cargo: r[4]
    };
}

/* FUNÇÕES DE LOGIN MANUAL DESATIVADAS
// 1. SOLICITA ACESSO
function requestAccess(id, nome, email) { ... }
 
// 2. LOGIN
function login(email, password) { ... }
 
// 3. TROCA DE SENHA
function changePassword(email, newPass, isFirstAccessFlow) { ... }
 
// 5. RECUPERAÇÃO DE SENHA
function requestPasswordReset(email) { ... }
*/

// =========================================================================
// API ENDPOINT (GET)
// =========================================================================

// [DUPLICATE DOGET REMOVED]

// Lógica de Fila isolada - ATUALIZADA para incluir email_gestor
// Lógica de Fila isolada - ATUALIZADA para incluir Resets e Espelhos
function handlePowerShellQueueRequest() {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    let usersToReset = [];

    // 1. FILA DE RESET (Solicitações)
    let sheetQueue = ss.getSheetByName("Solicitações");
    if (sheetQueue) {
        const qData = sheetQueue.getDataRange().getDisplayValues();
        if (qData.length > 1) {
            for (let i = 1; i < qData.length; i++) {
                let row = qData[i];
                if (row.length < 11) continue; // Precisa ter col 10 (Status_Aprovacao)

                let status = String(row[9]).toUpperCase().trim();          // Coluna J
                let statusAprovacao = String(row[10]).toUpperCase().trim(); // Coluna K

                if (status === "PENDENTE" && (statusAprovacao === "APROVADO" || statusAprovacao === "REPROVADO")) {
                    let filial = row[2];
                    let centroCusto = row[6];
                    let emailsLideres = [];
                    try { emailsLideres = fetchLeadersEmails(filial, centroCusto); } catch (e) { }

                    let emailGestor = (emailsLideres && emailsLideres.length > 0) ? emailsLideres[0] : "";

                    usersToReset.push({
                        task_type: "RESET",
                        id_solicitacao: row[0],
                        user_name: row[3],
                        nome: row[4],
                        email_colaborador: row[5],
                        email_gestor: emailGestor,
                        centro_custo: centroCusto,
                        aba: filial,
                        analista: row[7],
                        solicitante: row[8],
                        emails_lideres: emailsLideres,
                        status_aprovacao: statusAprovacao
                    });
                }
            }
        }
    }

    // 2. FILA DE ESPELHO (Espelho_Solicitacoes)
    let sheetMirror = ss.getSheetByName("Espelho_Solicitacoes");
    if (sheetMirror) {
        const mData = sheetMirror.getDataRange().getValues();
        if (mData.length > 1) {
            for (let i = 1; i < mData.length; i++) {
                let status = String(mData[i][7]).toUpperCase().trim();          // Coluna H
                let statusAprovacao = String(mData[i][9]).toUpperCase().trim(); // Coluna J

                if (status === "PENDENTE_EXECUCAO" && (statusAprovacao === "APROVADO" || statusAprovacao === "REPROVADO")) {
                    usersToReset.push({
                        task_type: "MIRROR",
                        id_solicitacao: String(mData[i][0]),
                        user_modelo: mData[i][2],
                        targets: JSON.parse(mData[i][3]), // Array de destinos
                        grupos: JSON.parse(mData[i][4]),  // Array de grupos
                        solicitante: mData[i][5],
                        analista: mData[i][6],
                        aba: "ESPELHO",
                        nome: "Espelho - " + mData[i][2],
                        user_name: "Multiplos",
                        status_aprovacao: statusAprovacao
                    });
                }
            }
        }
    }

    if (usersToReset.length === 0) {
        return ContentService.createTextOutput(JSON.stringify({ error: "[v1.0.5] Fila Vazia." }))
            .setMimeType(ContentService.MimeType.JSON);
    }

    return ContentService.createTextOutput(JSON.stringify(usersToReset)).setMimeType(ContentService.MimeType.JSON);
}

// =========================================================================
// GESTÃO DE ANALISTAS
// =========================================================================

function ATUALIZAR_CADASTRO_ANALISTAS() {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    let sheet = ss.getSheetByName("Analistas");

    if (!sheet) {
        sheet = ss.insertSheet("Analistas");
        sheet.appendRow(["ID_MAGALU", "NOME", "EMAIL", "SITUACAO_RH", "DATA_ATUALIZACAO"]);
        sheet.getRange(1, 1, 1, 5).setFontWeight("bold").setBackground("#d9ead3");
        throw new Error("Aba 'Analistas' criada. Insira IDs na Coluna A e execute novamente.");
    }

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) throw new Error("Insira IDs na coluna A.");

    const rangeIds = sheet.getRange(2, 1, lastRow - 1, 1);
    const ids = rangeIds.getValues().flat().filter(id => id && String(id).trim() !== "");

    if (ids.length === 0) throw new Error("Nenhum ID encontrado na coluna A.");

    const cleanIds = ids.map(id => `'${String(id).replace(/\D/g, "")}'`).join(",");

    const sql = `
        SELECT 
            CAST(t2.ID AS STRING) as ID,
            t2.NOME, 
            t1.email,
            t2.SITUACAO
        FROM \`maga-bigdata.kirk.assignee\` AS t1
        INNER JOIN \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` AS t2 
            ON t1.CUSTOM1 = CAST(t2.ID AS STRING)
        WHERE CAST(t2.ID AS STRING) IN (${cleanIds})
    `;

    const rows = executeQueryBQ(sql);

    const resultMap = new Map();
    rows.forEach(r => {
        resultMap.set(String(r[0]), {
            nome: r[1],
            email: r[2],
            situacao: r[3]
        });
    });

    const outputData = [];
    const timestamp = new Date();

    ids.forEach(id => {
        const cleanId = String(id).replace(/\D/g, "");
        const data = resultMap.get(cleanId);
        if (data) {
            const nomeFormatado = toTitleCase(data.nome);
            const emailMinusculo = String(data.email).toLowerCase();
            outputData.push([nomeFormatado, emailMinusculo, data.situacao, timestamp]);
        } else {
            outputData.push(["NÃO ENCONTRADO NO BQ", "-", "ERRO", timestamp]);
        }
    });

    sheet.getRange(2, 2, outputData.length, 4).setValues(outputData);
    Logger.log("Atualização concluída.");
}

function toTitleCase(str) {
    if (!str) return "";
    return String(str).toLowerCase().split(' ').map(function (word) {
        return (word.charAt(0).toUpperCase() + word.slice(1));
    }).join(' ');
}



function getAnalystsList() {
    const cache = CacheService.getScriptCache();
    const cached = cache.get("LISTA_ANALISTAS_SHEET_V2");
    if (cached) return JSON.parse(cached);

    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheet = ss.getSheetByName("Analistas");
    if (!sheet) return ["ERRO: Aba Analistas não existe"];

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return [];

    const data = sheet.getRange(2, 2, lastRow - 1, 3).getValues();

    const activeAnalysts = data
        .filter(r => {
            const nome = r[0];
            const situacao = String(r[2]).toLowerCase();
            return nome && nome !== "NÃO ENCONTRADO NO BQ" && (situacao.includes("atividade") || situacao.includes("normal"));
        })
        .map(r => r[0])
        .sort();

    cache.put("LISTA_ANALISTAS_SHEET_V2", JSON.stringify(activeAnalysts), 1200);
    return activeAnalysts;
}

// =========================================================================
// FUNÇÕES WEB APP (BUSCA, FILA)
// =========================================================================

function getFiliaisList() {
    const cache = CacheService.getScriptCache();
    const cached = cache.get("FILIAIS_LIST_BQ");
    if (cached) return JSON.parse(cached);

    const sql = `
        SELECT DISTINCT FILIAL 
        FROM \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` 
        WHERE SITUACAO = 'Em Atividade Normal' 
        ORDER BY FILIAL
    `;
    try {
        const rows = executeQueryBQ(sql);
        const filiais = rows.map(r => r[0]);
        cache.put("FILIAIS_LIST_BQ", JSON.stringify(filiais), 21600);
        return filiais;
    } catch (e) {
        return ["Erro ao buscar filiais (BQ)"];
    }
}

/**
 * BUSCA UNIVERAL / CORINGA BIGQUERY (v1.1.3)
 * Sem limites de resultados conforme solicitado.
 */
function searchUserBQ(query) {
    if (!query) throw new Error("Informe um termo para busca.");
    const term = String(query).replace(/'/g, "").toUpperCase().trim();

    const sql = `
        SELECT 
            t2.ID,
            t1.user_name,
            t2.NOME,
            t2.CARGO,
            t1.email,
            t2.CENTRO_CUSTO,
            t2.FILIAL
        FROM \`maga-bigdata.kirk.assignee\` AS t1
        INNER JOIN \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` AS t2 
            ON t1.CUSTOM1 = CAST(t2.ID AS STRING)
        WHERE (
            UPPER(t1.user_name) = '${term}' 
            OR UPPER(t2.NOME) LIKE '%${term}%'
            OR CAST(t2.ID AS STRING) = '${term}'
            OR CAST(t2.FILIAL AS STRING) = '${term}'
            OR UPPER(t1.email) = '${term}'
            OR UPPER(t1.email) LIKE '%${term}%'
        )
        AND t2.SITUACAO = 'Em Atividade Normal'
        ORDER BY t2.NOME
    `;

    try {
        const rows = executeQueryBQ(sql);
        let auditados = getUsuariosAuditados();

        return rows.map(row => ({
            id: row[0],
            user_name: row[1],
            nome: row[2],
            cargo: row[3],
            email: row[4],
            centro_custo: row[5],
            filial: row[6],
            ja_resetado: auditados.has(String(row[1]).toUpperCase().trim())
        }));
    } catch (e) {
        throw new Error("Erro BQ: " + e.message);
    }
}

/**
 * v1.5.1: Registra solicitação de BitLocker na fila com dados completos do BQ
 */
function submitBitlockerRequest(payload) {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheet = ss.getSheetByName("Solicitações");
    const timestamp = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss");

    const u = payload.userData || {};
    const lastRow = sheet.getLastRow();

    // Cálculo do próximo ID
    let nextId = 1;
    if (lastRow > 1) {
        const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
        nextId = Math.max(...ids.map(Number)) + 1;
    }

    sheet.appendRow([
        nextId,                              // ID (A)
        timestamp,                           // DATA (B)
        u.filial || "BITLOCKER",             // FILIAL (C)
        payload.hostname,                    // USER_NAME/HOSTNAME (D)
        u.nome || "Estação AD",              // NOME (E)
        u.email || "-",                      // EMAIL_COLAB (F)
        u.centro_custo || "-",               // CENTRO_CUSTO (G)
        payload.analystEmail || payload.analyst, // ANALISTA (H)
        payload.requester,                   // SOLICITANTE (I)
        "PENDENTE",                          // STATUS_PROCESSAMENTO (J)
        "APROVADO",                          // STATUS_APROVACAO (K)
        "BITLOCKER",                         // TIPO_TAREFA (L)
        payload.passwordId,                  // DETALHES_ADICIONAIS (M) -> 8 Dígitos do ID da Senha
        "", "", "", ""                       // N, O, P, Q
    ]);

    return { success: true, requestId: nextId };
}

function submitResetQueue(requestData) {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    let queueSheet = ss.getSheetByName("Solicitações");

    if (!queueSheet) {
        queueSheet = ss.insertSheet("Solicitações");
        // SCHEMA v1.3.0 (A-Q)
        queueSheet.appendRow(["ID", "DATA_HORA", "FILIAL", "USER_NAME", "NOME", "EMAIL_COLAB", "CENTRO_CUSTO", "ANALISTA_RESPONSAVEL", "SOLICITANTE", "STATUS_PROCESSAMENTO", "STATUS_APROVACAO", "TIPO_TAREFA", "DETALHES_ADICIONAIS", "MODELO", "DESTINOS", "GRUPOS", "ULTIMO_LEMBRETE"]);
        queueSheet.setTabColor("Blue");
        queueSheet.getRange(1, 1, 1, 17).setFontWeight("bold").setBackground("#cfe2f3");
        queueSheet.setFrozenRows(1);
    }

    const timestamp = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss"); // Formato String para consistência visual
    const requesterEmail = Session.getActiveUser().getEmail();

    // Mapeia Analista
    const analystData = mapAnalystByEmail(requesterEmail);
    const finalAnalystEmail = analystData ? analystData.email : requesterEmail;
    const finalAnalystName = analystData ? analystData.nome : requestData.analyst;
    const emailType = (requestData.task_type === "DESBLOQUEIO_CONTA") ? "DESBLOQUEIO" : "RESET";

    // 1. OTIMIZAÇÃO: Cálculo de IDs em lote
    let startId = 1;
    const lastRow = queueSheet.getLastRow();
    if (lastRow > 1) {
        const ids = queueSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
        const maxId = ids.reduce((max, val) => {
            const num = parseInt(val, 10);
            return !isNaN(num) && num > max ? num : max;
        }, 0);
        startId = maxId + 1;
    }

    // 2. OTIMIZAÇÃO: Construção da matriz de dados (Bulk Insert)
    const rowsToAdd = requestData.users.map((u, index) => {
        const currentId = startId + index;
        return [
            currentId,                      // A (0)
            timestamp,                      // B (1)
            requestData.filial || u.filial, // C (2)
            u.user_name,                    // D (3)
            u.nome,                         // E (4)
            u.email,                        // F (5)
            u.centro_custo,                 // G (6)
            finalAnalystEmail,              // H (7)
            requesterEmail,                 // I (8)
            "PENDENTE",                     // J (9)
            "PENDENTE",                     // K (10)
            requestData.task_type || "RESET", // L (11)
            "",                             // M (12)
            "",                             // N (13)
            "",                             // O (14)
            "",                             // P (15)
            ""                              // Q (16)
        ];
    });

    if (rowsToAdd.length > 0) {
        queueSheet.getRange(lastRow + 1, 1, rowsToAdd.length, rowsToAdd[0].length).setValues(rowsToAdd);
    }

    SpreadsheetApp.flush();

    // 3. OBSERVAÇÃO SOBRE EMAILS:
    // Enviar 1000 emails pode exceder cota/tempo. 
    // Mantemos o envio individual por enquanto, mas em blocos grandes idealmente seria assíncrono.
    // Para simplificar e atender o requisito de "registros individuais", focamos na planilha.
    // O envio abaixo pode demorar.

    // Opcional: Limitar envio de emails em massa para evitar timeout ou usar Gatilho.
    // Pelo pedido do usuário, "gerar solicitações" é prioridade.

    try {
        if (requestData.users.length <= 20) {
            // Envia para volumes pequenos
            requestData.users.forEach((u, i) => {
                sendApprovalEmail(finalAnalystName, finalAnalystEmail, (startId + i), emailType, u.user_name, u.nome);
            });
        } else {
            // Para volumes grandes, envia apenas um resumo ou processa assincronamente (TODO)
            // Por segurança, não vamos travar o script tentando enviar 1000 emails síncronos.
        }
    } catch (e) {
        console.error("Erro ao enviar emails de aprovação:", e);
    }

    return true;
}

/**
 * Busca dados do analista na aba 'Analistas' usando o e-mail da sessão.
 */
function mapAnalystByEmail(email) {
    if (!email) return null;
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheet = ss.getSheetByName("Analistas");
    if (!sheet) return null;

    const data = sheet.getDataRange().getValues();
    // Pula cabeçalho (i=1)
    for (let i = 1; i < data.length; i++) {
        // Coluna C (Index 2) é o EMAIL
        if (String(data[i][2]).toLowerCase().trim() === String(email).toLowerCase().trim()) {
            return {
                nome: data[i][1], // Coluna B
                email: data[i][2], // Coluna C
                situacao: data[i][3] // Coluna D
            };
        }
    }
    return null;
}

/**
 * Retorna o próximo ID sequencial para a aba Solicitações
 */
function getNextQueueId(sheet) {
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return 1;

    const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
    let maxId = 0;
    ids.forEach(id => {
        const numId = parseInt(id, 10);
        if (!isNaN(numId) && numId > maxId) {
            maxId = numId;
        }
    });

    return maxId + 1;
}

function getQueueWeb() {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheet = ss.getSheetByName("Solicitações");
    if (!sheet) return [];

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return [];

    // Retorna todos os registros (sem limite) - Ajustado para v1.2.1
    const data = sheet.getRange(2, 1, lastRow - 1, 16).getValues();

    return data.reverse().map(r => ({
        id: r[0],
        data: (r[1] instanceof Date) ? r[1].toISOString() : r[1],
        filial: String(r[2]),
        user: r[3],
        nome: r[4],
        analista: r[7],  // Col H (7) - Restaurado
        status: r[9],    // Col J (9) - Restaurado
        aprovacao: r[10],// Col K (10) - Restaurado
        tipo: r[11]      // Col L (11) - Restaurado
    }));
}

function getUsuariosAuditados() {
    let set = new Set();
    try {
        const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
        let sheet = ss.getSheetByName("Auditoria");
        if (!sheet) return set;

        if (sheet.getLastRow() > 1) {
            const dados = sheet.getRange(2, 3, sheet.getLastRow() - 1, 1).getValues();
            dados.forEach(r => set.add(String(r[0]).toUpperCase().trim()));
        }
    } catch (e) { }
    return set;
}

// ATUALIZADO: doPost agora processa e salva email_gestor + ID auto-incremental
function doPost(e) {
    try {
        const data = JSON.parse(e.postData.contents);
        const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);

        // 1. REPORTE DE STATUS DO DAEMON (v4.8)
        if (data.action === "report_status") {
            const sheetFila = ss.getSheetByName("Solicitações");
            const idReq = String(data.id).trim();
            const filaData = sheetFila.getDataRange().getValues();

            for (let i = 1; i < filaData.length; i++) {
                if (String(filaData[i][0]).trim() === idReq) {
                    // Col 10 (J): Status Processamento
                    // Col 13 (M): Detalhes Adicionais (Mensagem de Erro/Sucesso)
                    sheetFila.getRange(i + 1, 10).setValue(data.status);
                    if (data.message) {
                        sheetFila.getRange(i + 1, 13).setValue(data.message);
                    }
                    break;
                }
            }

            // Registra Auditoria para Resets/Desbloqueios
            if (data.status === "CONCLUIDO" || data.status === "ERRO") {
                const sheetAudit = ss.getSheetByName("Auditoria");
                if (sheetAudit) {
                    const row = filaData.find(r => String(r[0]).trim() === idReq);
                    if (row && (row[11] === "RESET" || row[11] === "DESBLOQUEIO_CONTA")) {
                        const nextId = getNextAuditId(sheetAudit);
                        sheetAudit.appendRow([
                            nextId,
                            new Date(),
                            row[2], // Filial
                            row[3], // User Name
                            "***",   // Senha (não trafegada no reporte por segurança)
                            data.status,
                            data.analista || row[7],
                            row[5], // Email Colab
                            "",     // Email Gestor (opcional)
                            row[6], // CC
                            data.message || "",
                            row[8]  // Solicitante
                        ]);
                    }
                }
            }
            return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);
        }

        // 1.1 LÓGICA DE ATUALIZAÇÃO DO AGENTE (FETCH_GROUPS)
        if (data.action === "update_mirror_result" && data.type !== "EXECUTE_MIRROR") {
            return updateMirrorResult(data);
        }

        // 1.2 BITLOCKER RESULT
        if (data.action === "update_bitlocker_result") {
            return updateBitlockerCustody(data); // FIX: Nome correto da função
        }

        // 2. LÓGICA DE EXECUÇÃO FINAL (Vindo do Script do Analista)
        if (data.type === "EXECUTE_MIRROR") {
            const sheetExec = ss.getSheetByName("Espelho_Solicitacoes");
            if (sheetExec) {
                const idReq = String(data.id_solicitacao).trim();
                const mData = sheetExec.getDataRange().getValues();
                for (let i = 1; i < mData.length; i++) {
                    if (String(mData[i][0]).trim() === idReq) {
                        sheetExec.getRange(i + 1, 8).setValue("FINALIZADO");
                        sheetExec.getRange(i + 1, 9).setValue(""); // Limpa erro
                        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);
                    }
                }
            }
            return ContentService.createTextOutput("ID Espelho não encontrado").setMimeType(ContentService.MimeType.TEXT);
        }

        return ContentService.createTextOutput("Ação não reconhecida").setMimeType(ContentService.MimeType.TEXT);
    } catch (e) {
        return ContentService.createTextOutput("Erro: " + e.message).setMimeType(ContentService.MimeType.TEXT);
    }
}

// =========================================================================
// FEATURE ESPELHO DE USUÁRIOS
// =========================================================================

function submitMirrorRequest(userModelo, requester) {
    if (!userModelo) throw new Error("Usuário modelo é obrigatório.");

    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    // SEGREGAÇÃO v1.3.4: Usa aba dedicada 'Dados_Espelhamento' para busca volátil
    let sheet = ss.getSheetByName("Dados_Espelhamento");

    if (!sheet) {
        sheet = ss.insertSheet("Dados_Espelhamento");
        sheet.appendRow(["ID", "DATA", "USER_MODELO", "SOLICITANTE", "STATUS", "GRUPOS_JSON", "MSG_ERRO"]);
        sheet.setTabColor("Orange");
        sheet.getRange(1, 1, 1, 7).setFontWeight("bold").setBackground("#f9cb9c");
    }

    const nextId = getNextMirrorId(sheet);
    const timestamp = new Date();

    sheet.appendRow([
        nextId,
        timestamp,
        userModelo,
        requester,
        "BUSCANDO_GRUPOS",
        "",
        ""
    ]);
    SpreadsheetApp.flush(); // Força escrita imediata

    return { success: true, requestId: nextId, message: "Solicitação enviada. Aguardando agente..." };
}

function checkMirrorStatus(requestId) {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    // SEGREGAÇÃO v1.3.4: Lê da aba Dados_Espelhamento
    const sheet = ss.getSheetByName("Dados_Espelhamento");
    if (!sheet) throw new Error("Aba Dados_Espelhamento não encontrada.");

    const data = sheet.getDataRange().getValues();
    // Busca pelo ID (Coluna A - index 0)
    for (let i = 1; i < data.length; i++) {
        if (String(data[i][0]).trim() === String(requestId).trim()) {
            // Schema Dados_Espelhamento:
            // 0:ID, 1:DATA, 2:MODELO, 3:SOLICITANTE, 4:STATUS, 5:GRUPOS, 6:ERRO
            const status = String(data[i][4] || "").toUpperCase().trim();
            const jsonGrupos = data[i][5];
            const msgErro = data[i][6];

            if (status === "CONCLUIDO" || status === "GRUPOS_ENCONTRADOS" || status === "SUCESSO") {
                let grupos = [];
                if (jsonGrupos) {
                    if (String(jsonGrupos).trim().indexOf('[') === 0) {
                        try { grupos = JSON.parse(jsonGrupos); } catch (e) { grupos = []; }
                    } else {
                        // Fallback split ;
                        grupos = String(jsonGrupos).split(';').filter(g => g);
                    }
                }
                return { status: "CONCLUIDO", groups: grupos };
            }

            if (status === "ERRO" || status === "REPROVADO") {
                return { status: "ERRO", message: msgErro || "Erro ao buscar grupos." };
            }

            return { status: "PENDENTE" };
        }
    }
    throw new Error("Solicitação não encontrada.");
}

// Chamado pelo PowerShell via GET
function handleMirrorQueueCheck() {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    let requests = [];

    // 1. Busca na fila de capturar grupos (Espelho_Fila) - NÃO PRECISA DE APROVAÇÃO (É SÓ LEITURA)
    const sheetFila = ss.getSheetByName("Espelho_Fila");
    if (sheetFila) {
        const dataFila = sheetFila.getDataRange().getValues();
        for (let i = 1; i < dataFila.length; i++) {
            const status = String(dataFila[i][4]).trim();
            if (status === "BUSCANDO_GRUPOS") {
                requests.push({
                    type: "FETCH_GROUPS",
                    id: String(dataFila[i][0]),
                    user_modelo: dataFila[i][2]
                });
            }
        }
    }

    // 2. Busca na fila de executar espelhamento (Espelho_Solicitacoes) - PRECISA DE APROVAÇÃO
    const sheetExec = ss.getSheetByName("Espelho_Solicitacoes");
    if (sheetExec) {
        const dataExec = sheetExec.getDataRange().getValues();
        for (let i = 1; i < dataExec.length; i++) {
            const status = String(dataExec[i][7]).trim();          // Coluna H (8)
            const statusAprovacao = String(dataExec[i][9]).trim(); // Coluna J (10)

            // Só processa se estiver Pendente de Execução E Aprovado pelo analista
            if (status === "PENDENTE_EXECUCAO" && statusAprovacao === "APROVADO") {
                requests.push({
                    type: "EXECUTE_MIRROR",
                    id: String(dataExec[i][0]),
                    user_modelo: dataExec[i][2],
                    destinos: JSON.parse(dataExec[i][3]),
                    grupos: JSON.parse(dataExec[i][4])
                });
            }
        }
    }

    return ContentService.createTextOutput(JSON.stringify(requests)).setMimeType(ContentService.MimeType.JSON);
}

// Chamado pelo PowerShell via POST
function updateMirrorResult(payload) {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const type = payload.type || "FETCH_GROUPS";

    // SEGREGAÇÃO v1.3.4: Define aba alvo baseado no tipo
    const sheetName = (type === "FETCH_GROUPS") ? "Dados_Espelhamento" : "Solicitações";
    const sheet = ss.getSheetByName(sheetName);

    if (!sheet) return ContentService.createTextOutput("Erro: Aba " + sheetName + " nao existe").setMimeType(ContentService.MimeType.TEXT);

    const idReq = String(payload.id || payload.requestId).trim();
    const status = payload.status;
    const msg = payload.msg_error;
    const grupos = payload.grupos || payload.groups; // Payload do Daemon

    const data = sheet.getDataRange().getValues();

    // Mapeamento de Colunas (0-based)
    // Se Dados_Espelhamento: Status=4(E), Grupos=5(F), Erro=6(G)
    // Se Solicitações: Status=9(J), Detalhes=12(M)

    // Config: [StatusCol, ErrorCol, ResultCol]
    let cfg = (type === "FETCH_GROUPS") ? [4, 6, 5] : [9, 12, null];

    for (let i = 1; i < data.length; i++) {
        if (String(data[i][0]).trim() === idReq) {

            // SUCESSO
            if (status === "SUCESSO" || status === "GRUPOS_ENCONTRADOS" || status === "CONCLUIDO") {
                // Para FETCH, status é GRUPOS_ENCONTRADOS ou SUCESSO -> CONCLUIDO
                // Para EXECUTE, status é CONCLUIDO -> FINALIZADO (ou mantém CONCLUIDO se padronizou)

                // Vamos padronizar escrita:
                if (type === "FETCH_GROUPS") {
                    sheet.getRange(i + 1, cfg[0] + 1).setValue("CONCLUIDO");
                    if (grupos) sheet.getRange(i + 1, cfg[2] + 1).setValue(grupos);
                } else {
                    sheet.getRange(i + 1, cfg[0] + 1).setValue("CONCLUIDO");
                    // Se houver mensagem de sucesso, pode por em detalhes? opcional.
                }
            }
            // REPROVADO
            else if (status === "REPROVADO") {
                sheet.getRange(i + 1, cfg[0] + 1).setValue("REPROVADO");
                // Se for solicitações, temos STATUS_APROVACAO na col K (10)
                if (type !== "FETCH_GROUPS") sheet.getRange(i + 1, 11).setValue("REPROVADO");
                sheet.getRange(i + 1, cfg[1] + 1).setValue(msg);
            }
            // ERRO
            else {
                sheet.getRange(i + 1, cfg[0] + 1).setValue("ERRO");
                sheet.getRange(i + 1, cfg[1] + 1).setValue(msg);
            }

            SpreadsheetApp.flush();
            return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);
        }
    }
    return ContentService.createTextOutput("ID nao encontrado").setMimeType(ContentService.MimeType.TEXT);
}





function getBitlockerKey(requestId) {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheetKeys = ss.getSheetByName("Bitlocker_Keys");
    if (!sheetKeys) return { success: false, message: "Base de chaves não encontrada" };

    const data = sheetKeys.getDataRange().getValues();
    // Busca de baixo para cima para pegar o mais recente se houver duplicidade (retry)
    for (let i = data.length - 1; i >= 1; i--) {
        if (String(data[i][0]).trim() === String(requestId).trim()) {
            return {
                success: true,
                recoveryKey: data[i][3],
                passwordId: data[i][4],
                hostname: data[i][2]
            };
        }
    }
    return { success: false, message: "Chave não encontrada ou ainda não processada." };
}

function getNextMirrorId(sheet) {
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return 1;
    const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
    let max = 0;
    ids.forEach(id => {
        let n = parseInt(id, 10);
        if (!isNaN(n) && n > max) max = n;
    });
    return max + 1;
}

/**
 * 2ª ETAPA DO ESPELHO: Registra a execução para o Analista
 */
/**
 * 2ª ETAPA DO ESPELHO: Registra a execução para o Analista
 */
// 1. EXECUÇÃO DE ESPELHAMENTO (Agora vai para a fila Unificada "Solicitações")
function submitMirrorExecution(payload) {
    if (!payload.modelUser || !payload.targets || payload.targets.length === 0) {
        throw new Error("Dados incompletos para espelhamento.");
    }

    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheet = ss.getSheetByName("Solicitações");
    const timestamp = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy HH:mm:ss");

    // FIX v1.3.6: Individualização de Solicitações
    // Cada alvo gera uma linha independente na aba Solicitações.

    // Normalização de input (garante array de objetos ou strings)
    let targetsData = [];
    if (typeof payload.targets[0] === 'object') {
        targetsData = payload.targets; // Já é [{user_name, nome, email, centro_custo}, ...]
    } else {
        // Fallback para strings (legado)
        targetsData = payload.targets.map(t => ({
            user_name: String(t),
            nome: "Usuário AD",
            email: "",
            centro_custo: ""
        }));
    }

    // Calcula IDs em lote para performance (Evita chamadas repetidas de getNextQueueId)
    let startId = 1;
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
        // Pega o maior ID da coluna A
        const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
        const maxId = ids.reduce((max, val) => {
            const num = parseInt(val, 10);
            return !isNaN(num) && num > max ? num : max;
        }, 0);
        startId = maxId + 1;
    }

    // Prepara as linhas para inserção em lote
    const rowsToAdd = targetsData.map((t, index) => {
        const currentId = startId + index;

        // Coluna O (Destinos) para o Daemon espera um ARRAY JSON.
        // Como estamos individualizando, cada linha manda um array com 1 único elemento.
        const targetArrayForDaemon = [t.user_name];

        return [
            currentId,                      // A (0) ID Único
            timestamp,                      // B (1) Data
            t.filial || "ESPELHO",          // C (2) Filial Real (ou fallback se vazio)
            t.user_name,                    // D (3) User Name Real
            t.nome,                         // E (4) Nome Real (SEM sufixo Espelho)
            t.email || "",                  // F (5) Email Real
            t.centro_custo || "",           // G (6) Centro de Custo Real
            payload.analyst,                // H (7) Analista
            payload.requester,              // I (8) Solicitante
            "PENDENTE",                     // J (9) Status
            "PENDENTE",                     // K (10) Status Aprovação (CORREÇÃO: Fluxo de Email necessário)
            "MIRROR",                       // L (11) Tipo
            "",                             // M (12) Detalhes
            payload.modelUser,              // N (13) Modelo
            JSON.stringify(targetArrayForDaemon), // O (14) Destinos (Array de 1)
            JSON.stringify(payload.groups), // P (15) Grupos
            ""                              // Q (16) SLA
        ];
    });

    // Inserção em lote (performance)
    if (rowsToAdd.length > 0) {
        sheet.getRange(lastRow + 1, 1, rowsToAdd.length, rowsToAdd[0].length).setValues(rowsToAdd);
    }

    SpreadsheetApp.flush();

    // Envio de Emails de Aprovação (Limitado a 20 para evitar timeout)
    try {
        if (rowsToAdd.length <= 20) {
            targetsData.forEach((t, index) => {
                const reqId = startId + index;
                // Assumindo sendApprovalEmail(requesterName, requesterEmail, requestId, type, targetUser, targetName)
                // Usamos payload.analyst como destinatário da aprovação
                const analystName = payload.analyst.split('@')[0];
                sendApprovalEmail(analystName, payload.analyst, reqId, "MIRROR", t.user_name, t.nome);
            });
        }
    } catch (e) {
        // Log silently
    }

    // Dispara gatilho SLA
    try { ScriptApp.newTrigger("runSLACheck").timeBased().after(1000).create(); } catch (e) { }

    return { success: true, message: rowsToAdd.length + " espelhamento(s) solicitado(s) individualmente e enviados para aprovação!" };
}

// =========================================================================
// FLUXO DE APROVAÇÃO (DO GET WEB APP)
// =========================================================================

// [DUPLICATE DOGET REMOVED]

function handleApprovalAction(e) {
    const action = e.parameter.action; // approve | reject
    const id = e.parameter.id;
    const type = e.parameter.type; // RESET | MIRROR

    if (!id) return HtmlService.createHtmlOutput("<h3>Erro: ID não informado.</h3>");

    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    // UNIFICAÇÃO v1.2.1: Tudo na aba Solicitações
    const sheetName = "Solicitações";
    const statusCol = 11; // Coluna K (Status Aprovação) (1-based index)

    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) return HtmlService.createHtmlOutput("<h3>Erro: Base de dados não encontrada.</h3>");

    const data = sheet.getDataRange().getValues();
    let found = false;
    let newStatus = (action === "approve") ? "APROVADO" : "REPROVADO";

    for (let i = 1; i < data.length; i++) {
        if (String(data[i][0]).trim() === String(id)) {
            // Verifica se já foi finalizado (Col J = Index 9)
            if (String(data[i][9]).match(/SUCESSO|CONCLU|FINALIZADO/)) {
                return HtmlService.createHtmlOutput("<h2 style='color:orange'>Atenção: Esta solicitação já foi finalizada.</h2>");
            }

            // Atualiza STATUS_APROVACAO
            sheet.getRange(i + 1, statusCol).setValue(newStatus);
            found = true;
            break;
        }
    }

    if (found) {
        let cor = (action === "approve") ? "green" : "red";
        let texto = (action === "approve") ? "APROVADA" : "REPROVADA";
        return HtmlService.createHtmlOutput(`
                <div style='font-family: Arial; text-align: center; padding: 50px;'>
                    <h1 style='color:${cor}'>SOLICITAÇÃO ${texto} COM SUCESSO!</h1>
                    <p>O sistema processará a requisição conforme sua decisão.</p>
                    <p>Pode fechar esta janela.</p>
                </div>
            `);
    } else {
        return HtmlService.createHtmlOutput("<h3 style='color:red'>Erro: ID da solicitação não encontrado.</h3>");
    }
}

function sendRejectionEmail(requesterEmail, analystEmail, requestId, type) {
    if (!requesterEmail) return;

    const subject = `🚫 Solicitação Reprovada: #${requestId}`;
    // Tenta obter nome do analista a partir do email (opcional, ou usa o proprio email)
    const analystName = analystEmail ? analystEmail.split("@")[0] : "Suporte";

    // Se analystEmail for válido, usamos a personificação. Se não, vai genérico.
    // Para simplificar, usamos a mesma logica do sendApproval

    let htmlBody = `
        <div style="font-family: Arial, sans-serif; padding: 20px; color: #333;">
            <h2 style="color: #dc2626;">Solicitação Reprovada</h2>
            <p>Olá,</p>
            <p>Informamos que sua solicitação <strong>#${requestId}</strong> (${type}) foi <strong>REPROVADA</strong> pelo analista responsável.</p>
            <p><strong>Motivo/Ação:</strong> Para entender o motivo da rejeição ou ajustar a solicitação, por favor entre em contato diretamente com o analista responsável.</p>
            
            <p style="background-color: #f3f4f6; padding: 10px; border-radius: 5px; margin-top: 15px;">
                <strong>Analista Responsável:</strong> ${analystEmail || "Não identificado"}<br>
            </p>
            
            <hr style="margin-top: 30px; border: 0; border-top: 1px solid #eee;">
            <p style="font-size: 12px; color: #666;">Sistema de Gerenciamento de Identidades</p>
        </div>
    `;

    try {
        MailApp.sendEmail({
            to: requesterEmail,
            subject: subject,
            name: `Sistema de Reset (via ${analystName})`,
            replyTo: analystEmail || requesterEmail, // Se reclamar, user fala com analista
            htmlBody: htmlBody
        });
    } catch (e) {
        console.error("Erro envio reprovação: " + e.message);
    }
}

function sendApprovalEmail(analystName, analystEmail, requestId, type, info1, info2) {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheetAnalistas = ss.getSheetByName("Analistas");
    if (!sheetAnalistas) return;

    const data = sheetAnalistas.getDataRange().getValues();
    let emailDestino = "";

    // Busca o email do analista na planilha (caso não venha por parâmetro ou para validar)
    for (let i = 1; i < data.length; i++) {
        if (String(data[i][1]).trim() === String(analystName).trim()) {
            emailDestino = data[i][2];
            break;
        }
    }

    if (!emailDestino) {
        if (analystEmail && analystEmail.includes("@")) {
            emailDestino = analystEmail;
        } else {
            return;
        }
    }

    // Constrói Links
    const scriptUrl = ScriptApp.getService().getUrl();
    const linkApprove = `${scriptUrl}?action=approve&id=${requestId}&type=${type}`;
    const linkReject = `${scriptUrl}?action=reject&id=${requestId}&type=${type}`;

    let subject = "";
    let detailHtml = "";

    if (type === "RESET") {
        subject = `🔐 Validação: Reset Senha #${requestId}`;
        detailHtml = `<p><strong>Tipo:</strong> RESET DE SENHA</p>
                      <p><strong>ID Chamado:</strong> #${requestId}</p>
                      <p><strong>Usuário:</strong> ${info1}</p>
                      <p><strong>Nome:</strong> ${info2}</p>`;
    } else if (type === "DESBLOQUEIO" || type === "DESBLOQUEIO_CONTA") {
        subject = `🔓 Validação: Desbloqueio Conta #${requestId}`;
        detailHtml = `<p><strong>Tipo:</strong> DESBLOQUEIO DE CONTA</p>
                      <p><strong>ID Chamado:</strong> #${requestId}</p>
                      <p><strong>Usuário:</strong> ${info1}</p>
                      <p><strong>Nome:</strong> ${info2}</p>`;
    } else {
        subject = `👥 Validação: Espelhamento #${requestId}`;
        detailHtml = `<p><strong>Tipo:</strong> ESPELHAMENTO (MIRROR)</p>
                      <p><strong>ID Chamado:</strong> #${requestId}</p>
                      <p><strong>Usuário Modelo:</strong> ${info1}</p>
                      <p><strong>Detalhes:</strong> ${info2}</p>`;
    }

    try {
        MailApp.sendEmail({
            to: emailDestino,
            subject: subject,
            name: `Sistema de Reset (via ${analystName})`,
            replyTo: analystEmail || emailDestino,
            htmlBody: `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        @media only screen and (max-width: 480px) {
                            .container { padding: 15px !important; margin: 10px !important; width: auto !important; }
                            .btn-container { text-align: center !important; }
                            .btn { 
                                display: block !important; 
                                width: 100% !important; 
                                margin: 10px 0 !important; 
                                padding: 15px 0 !important; 
                                text-align: center !important;
                                box-sizing: border-box !important;
                            }
                        }
                    </style>
                </head>
                <body style="margin: 0; padding: 0; background-color: #f9fafb;">
                    <div class="container" style="font-family: 'Segoe UI', Arial, sans-serif; padding: 30px; border: 1px solid #e5e7eb; border-radius: 12px; max-width: 600px; margin: 40px auto; background-color: #ffffff; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                        <h2 style="color: #1e40af; margin-top: 0; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">Validação de Solicitação Técnica</h2>
                        <p style="color: #374151; font-size: 16px;">Olá <strong>${analystName}</strong>,</p>
                        <p style="color: #4b5563; font-size: 14px; line-height: 1.5;">Uma nova solicitação requer sua <strong>APROVAÇÃO</strong> manual antes de ser executada pelo Agente AD.</p>
                        
                        <div style="background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 25px 0; border: 1px solid #e5e7eb;">
                             ${detailHtml}
                        </div>

                        <div class="btn-container" style="text-align: center; margin-top: 35px;">
                            <a href="${linkApprove}" class="btn" style="background-color: #16a34a; color: white; padding: 14px 28px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block; margin: 5px; min-width: 160px; font-size: 14px; letter-spacing: 0.5px;">
                                ✅ APROVAR
                            </a>
                            <a href="${linkReject}" class="btn" style="background-color: #dc2626; color: white; padding: 14px 28px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block; margin: 5px; min-width: 160px; font-size: 14px; letter-spacing: 0.5px;">
                                🚫 REPROVAR
                            </a>
                        </div>
                        
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #f3f4f6; color: #9ca3af; font-size: 12px; text-align: center;">
                            <p>* Ao clicar em um dos botões, sua decisão será registrada e processada.<br>
                            Sistema de Gerenciamento de Identidades - Suporte Infra CDs</p>
                        </div>
                    </div>
                </body>
                </html>
            `
        });
    } catch (e) {
        console.error("Erro ao enviar email aprovação: " + e.message);
    }
}

/**
 * Retorna o próximo ID sequencial para a aba Auditoria
 */
function getNextAuditId(sheet) {
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return 1; // Primeira solicitação

    // Lê todos os IDs existentes na coluna A (exceto cabeçalho)
    const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();

    // Encontra o maior ID numérico
    let maxId = 0;
    ids.forEach(id => {
        const numId = parseInt(id, 10);
        if (!isNaN(numId) && numId > maxId) {
            maxId = numId;
        }
    });

    return maxId + 1;
}

/**
 * FUNÇÃO UTILITÁRIA: Numera registros existentes na aba Auditoria
 * Execute manualmente uma vez para preencher IDs em registros antigos
 */
function NUMERAR_AUDITORIA_EXISTENTE() {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheet = ss.getSheetByName("Auditoria");
    if (!sheet) throw new Error("Aba Auditoria não encontrada.");

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) throw new Error("Nenhum registro para numerar.");

    // Verifica se primeira coluna é "ID" no cabeçalho
    const header = sheet.getRange(1, 1).getValue();
    if (String(header).toUpperCase() !== "ID") {
        throw new Error("A coluna A deve ter o cabeçalho 'ID'. Ajuste a planilha manualmente.");
    }

    // Gera IDs sequenciais para linhas sem ID
    const existingIds = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
    const updates = [];

    let currentId = 1;
    for (let i = 0; i < existingIds.length; i++) {
        const val = existingIds[i][0];
        if (!val || val === "" || val === null) {
            updates.push([currentId]);
        } else {
            // Mantém ID existente se válido
            const existingNum = parseInt(val, 10);
            if (!isNaN(existingNum)) {
                currentId = existingNum;
                updates.push([existingNum]);
            } else {
                updates.push([currentId]);
            }
        }
        currentId++;
    }

    // Escreve todos os IDs de volta
    sheet.getRange(2, 1, updates.length, 1).setValues(updates);
    Logger.log("Numeração concluída. " + updates.length + " registros processados.");
}

// =========================================================================
// HELPERS (BIGQUERY e UTILS)
// =========================================================================

function executeQueryBQ(sql) {
    try {
        const request = { query: sql, useLegacySql: false };
        let queryResults = BigQuery.Jobs.query(request, PROJECT_ID_API);
        const jobId = queryResults.jobReference.jobId;

        let sleepTimeMs = 500;
        while (!queryResults.jobComplete) {
            Utilities.sleep(sleepTimeMs);
            sleepTimeMs *= 2;
            if (sleepTimeMs > 5000) sleepTimeMs = 5000;
            queryResults = BigQuery.Jobs.getQueryResults(PROJECT_ID_API, jobId);
        }

        let rows = queryResults.rows;
        while (queryResults.pageToken) {
            queryResults = BigQuery.Jobs.getQueryResults(PROJECT_ID_API, jobId, { pageToken: queryResults.pageToken });
            if (queryResults.rows) rows = rows.concat(queryResults.rows);
        }

        if (!rows) return [];
        return rows.map(r => r.f.map(c => c.v));

    } catch (e) {
        throw new Error("Erro ao consultar BigQuery: " + e.message);
    }
}

function fetchLeadersEmails(filial, centroCusto) {
    if (!filial) return [];
    const sanFilial = String(filial).replace(/'/g, "").trim();
    const sanCC = centroCusto ? String(centroCusto).replace(/'/g, "").trim() : "";

    // PASSO 1: Busca líderes no mesmo Centro de Custo
    if (sanCC) {
        const sqlCC = `
            SELECT DISTINCT t1.email
            FROM \`maga-bigdata.kirk.assignee\` AS t1
            INNER JOIN \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` AS t2 
                ON t1.CUSTOM1 = CAST(t2.ID AS STRING)
            WHERE 
                CAST(t2.FILIAL AS STRING) = '${sanFilial}'
                AND t2.CENTRO_CUSTO = '${sanCC}'
                AND t2.SITUACAO = 'Em Atividade Normal'
                AND (
                    UPPER(t2.CARGO) LIKE '%GERENTE%' 
                    OR UPPER(t2.CARGO) LIKE '%GESTOR%'
                    OR UPPER(t2.CARGO) LIKE '%GESTORA%'
                    OR UPPER(t2.CARGO) LIKE '%COORDENADOR%' 
                    OR UPPER(t2.CARGO) LIKE '%COORDENADORA%'
                )
            LIMIT 10
        `;

        const rowsCC = executeQueryBQ(sqlCC);
        if (rowsCC && rowsCC.length > 0) {
            const emailsCC = rowsCC.map(r => r[0]).filter(e => e && e.includes('@'));
            if (emailsCC.length > 0) {
                console.log("Líderes encontrados no CC: " + emailsCC.join(", "));
                return emailsCC;
            }
        }
    }

    // PASSO 2: Fallback - Busca líderes na Filial inteira (apenas cargos de alta responsabilidade)
    const sqlFilial = `
        SELECT DISTINCT t1.email, t2.CARGO
        FROM \`maga-bigdata.kirk.assignee\` AS t1
        INNER JOIN \`maga-bigdata.mlpap.mag_v_funcionarios_ativos\` AS t2 
            ON t1.CUSTOM1 = CAST(t2.ID AS STRING)
        WHERE 
            CAST(t2.FILIAL AS STRING) = '${sanFilial}'
            AND t2.SITUACAO = 'Em Atividade Normal'
            AND (
                UPPER(t2.CARGO) LIKE '%GERENTE%' 
                OR UPPER(t2.CARGO) LIKE '%GESTOR%'
                OR UPPER(t2.CARGO) LIKE '%GESTORA%'
                OR UPPER(t2.CARGO) LIKE '%COORDENADOR%' 
                OR UPPER(t2.CARGO) LIKE '%COORDENADORA%'
            )
        ORDER BY 
            CASE 
                WHEN UPPER(t2.CARGO) LIKE '%GERENTE%' THEN 1
                WHEN UPPER(t2.CARGO) LIKE '%COORDENADOR%' OR UPPER(t2.CARGO) LIKE '%COORDENADORA%' THEN 2
                WHEN UPPER(t2.CARGO) LIKE '%GESTOR%' OR UPPER(t2.CARGO) LIKE '%GESTORA%' THEN 3
                ELSE 4
            END
        LIMIT 15
    `;

    const rowsFilial = executeQueryBQ(sqlFilial);
    if (!rowsFilial || rowsFilial.length === 0) {
        console.log("Nenhum líder encontrado na filial " + sanFilial);
        return [];
    }

    const emailsFilial = rowsFilial.map(r => r[0]).filter(e => e && e.includes('@'));
    console.log("Líderes encontrados na FILIAL (fallback): " + emailsFilial.join(", "));
    return emailsFilial;
}


// =========================================================================
// API UNIFICADA (DAEMON V4)
// =========================================================================

function handleUnifiedQueue() {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    let requests = [];

    // 1. FILA ÚNICA UNIFICADA (v1.2.0)
    const sheetMaster = ss.getSheetByName("Solicitações");
    if (sheetMaster) {
        const data = sheetMaster.getDataRange().getDisplayValues();
        for (let i = 1; i < data.length; i++) {
            let row = data[i];

            let statusProc = row[9] ? String(row[9]).toUpperCase().trim() : "";  // Col J
            let statusAprov = row[10] ? String(row[10]).toUpperCase().trim() : ""; // Col K
            let taskType = row[11] ? String(row[11]).toUpperCase().trim() : "RESET"; // Col L

            if (statusProc === "PENDENTE" && (statusAprov === "APROVADO" || statusAprov === "REPROVADO")) {
                let r = {
                    id_solicitacao: row[0],
                    task_type: taskType,
                    status_aprovacao: statusAprov,
                    analista: row[7],     // Col H
                    solicitante: row[8],  // Col I
                    aba: row[2],          // Col C (Filial)
                    nome: row[4],
                    user_name: row[3],
                };

                // Dados Específicos por Tipo
                if (taskType === "MIRROR" || taskType === "ESPELHO_USUARIO" || taskType === "FETCH_GROUPS") {
                    r.user_modelo = row[13]; // Col N

                    // FETCH_GROUPS não tem targets/grupos ainda
                    if (taskType !== "FETCH_GROUPS") {
                        r.targets = JSON.parse(row[14] || "[]"); // Col O
                        r.grupos = JSON.parse(row[15] || "[]");  // Col P
                    }
                } else if (taskType === "BITLOCKER") {
                    // BitLocker não precisa de senha
                    r.hostname = row[3]; // Col D = User Name / Hostname
                    r.password_id_prefix = row[12]; // Col M = Prefixo do ID da Senha
                } else {
                    // Reset / Unlock
                    r.nova_senha = generatePassword();
                    r.email_colaborador = row[5];
                    r.centro_custo = row[6];
                }

                requests.push(r);
            }
        }
    }

    // 2. FETCH GROUPS (SEGREGAÇÃO v1.3.4 - Lê de Dados_Espelhamento)
    const sheetFila = ss.getSheetByName("Dados_Espelhamento");
    if (sheetFila) {
        const fData = sheetFila.getDataRange().getValues();
        for (let i = 1; i < fData.length; i++) {
            let status = String(fData[i][4]).trim();
            if (status === "BUSCANDO_GRUPOS") {
                requests.push({
                    task_type: "FETCH_GROUPS",
                    id_solicitacao: String(fData[i][0]),
                    user_modelo: fData[i][2]
                });
            }
        }
    }

    return ContentService.createTextOutput(JSON.stringify(requests)).setMimeType(ContentService.MimeType.JSON);
}

function debugSheetReader() {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheet = ss.getSheetByName("Solicitações");
    if (!sheet) return "Sheet nao encontrada";
    // Ultimas 5 linhas
    const values = sheet.getDataRange().getDisplayValues();
    const headers = values[0]; // Header
    const last5 = values.slice(-5);

    return JSON.stringify({
        headers: headers,
        last_rows: last5
    });
}

function generatePassword() {
    const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&*";
    let password = "";
    for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

/**
 * SISTEMA DE SLA (v1.3.0)
 * Monitora e envia lembretes a cada 1h para itens pendentes há > 2h.
 * Os lembretes param automaticamente quando o status deixa de ser 'PENDENTE'.
 */
function runSLACheck() {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheet = ss.getSheetByName("Solicitações");
    if (!sheet) return;

    ensureHeaders(sheet);
    const data = sheet.getDataRange().getValues();
    const now = new Date();
    const TWO_HOURS = 2 * 60 * 60 * 1000;
    const ONE_HOUR = 1 * 60 * 60 * 1000;

    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const createdAt = row[1]; // Col B (Index 1)
        const anaEmail = row[7];  // Col H (Index 7)
        const statusAprov = String(row[10] || "").toUpperCase().trim(); // Col K (Index 10)
        const id = row[0];
        const tipo = row[11]; // Col L (Index 11)
        const usuarioNome = row[4]; // Col E (Index 4)
        const ultimoLembrete = row[16]; // Col Q (Index 16)

        // FILTRO CRÍTICO: Somente PENDENTE e criadas há mais de 2 horas
        if (statusAprov === "PENDENTE" && (createdAt instanceof Date) && (now - createdAt) > TWO_HOURS) {

            let deveNotificar = false;
            if (!ultimoLembrete || !(ultimoLembrete instanceof Date)) {
                deveNotificar = true; // Primeiro lembrete
            } else if ((now - ultimoLembrete) >= ONE_HOUR) {
                deveNotificar = true; // Lembrete recorrente
            }

            if (deveNotificar && anaEmail && anaEmail.includes("@")) {
                try {
                    const template = HtmlService.createTemplateFromFile('AppsScript_SLA_Template');
                    template.analistaNome = anaEmail.split('.')[0].toUpperCase();
                    template.idSolicitacao = id;
                    template.tipoTarefa = tipo;
                    template.dataCriacao = createdAt.toLocaleString();
                    template.usuarioNome = usuarioNome;

                    const htmlBody = template.evaluate().getContent();

                    GmailApp.sendEmail(anaEmail, "⚠️ ALERTA DE SLA: Solicitação #" + id + " pendente", "", {
                        htmlBody: htmlBody,
                        name: "Suporte Infra (Alerta SLA)"
                    });

                    // Registra timestamp do envio para controle de recorrência - Col Q (Index 17 para o Sheets)
                    sheet.getRange(i + 1, 17).setValue(now);
                    console.log("SLA: Lembrete enviado para " + anaEmail + " (ID #" + id + ")");
                } catch (e) {
                    console.error("Erro SLA p/ " + anaEmail + ": " + e);
                }
            }
        }
    }
}

/**
 * Cria o trigger horário se ele não existir
 */
function setupSLATrigger() {
    const fn = "runSLACheck";
    const triggers = ScriptApp.getProjectTriggers();
    if (!triggers.some(t => t.getHandlerFunction() === fn)) {
        ScriptApp.newTrigger(fn).timeBased().everyHours(1).create();
        console.log("Trigger de SLA configurado.");
    }
}

function ensureHeaders(sheet) {
    const expected = ["ID", "DATA_HORA", "FILIAL", "USER_NAME", "NOME", "EMAIL_COLAB", "CENTRO_CUSTO", "ANALISTA_RESPONSAVEL", "SOLICITANTE", "STATUS_PROCESSAMENTO", "STATUS_APROVACAO", "TIPO_TAREFA", "DETALHES_ADICIONAIS", "MODELO", "DESTINOS", "GRUPOS", "ULTIMO_LEMBRETE"];
    const currentHeaders = sheet.getRange(1, 1, 1, expected.length).getValues()[0];

    let needsUpdate = false;
    for (let i = 0; i < expected.length; i++) {
        if (String(currentHeaders[i] || "").trim() !== expected[i]) {
            needsUpdate = true;
            break;
        }
    }

    if (needsUpdate) {
        sheet.getRange(1, 1, 1, expected.length).setValues([expected]).setFontWeight("bold").setBackground("#cfe2f3");
        sheet.setFrozenRows(1);
    }
}
function getAnalystsList() {
    // Tenta usar a lista global do Frontend.js, senão usa fallback
    if (typeof LISTA_ANALISTAS !== 'undefined') {
        return LISTA_ANALISTAS;
    }
    return [
        "Adriano Machado", "Andson Santos", "Bruna Mueller", "Bruno Montilha", "Carlos Boaventura",
        "Caroline Lima", "Cassiano Teles", "Cleriston Rodrigues", "Didimo Silva", "Douglas Souza",
        "EdsonJunior", "Eduardo Silva", "Estermah Santos", "Fabiano  Rosa", "Francisco Regis",
        "Gabriel Namura", "Gabriel Lima", "Gabriel Villar", "Genison Santos", "Gladson Ferreira",
        "Glauber Vieira", "Helder Ito", "Iugner Santos", "Jacob Lima", "Jair Dias", "Jeronimo Moraes",
        "Kaio Vargas", "Karine Oliveira", "Leandro Araujo", "Leo Rezende", "Levi Dantas",
        "Lucas Silva", "Marcos Freiberger", "Matheus Sinflorio", "Max Weber", "MichelleRodrigues",
        "Naldimar Barros", "Paulo Bizzi", "Pedro Figur", "Rafaela Camecran", "Raiane  Aguiar",
        "Rodrigo Lima", "Rodrigo Costa", "Silas Ferreira", "Thiago Miranda", "Thiago Honorio",
        "Victor Pedroza", "Vinicius Silva", "Wesley Faria", "William Fernandes"
    ];
}

/**
 * v1.5.0: API Otimizada para lista de analistas
 * Retorna apenas {nome, email} de analistas ATIVOS
 */
function getAnalystsListAPI() {
    const cache = CacheService.getScriptCache();
    const cached = cache.get("API_ANALISTAS_LITE");
    if (cached) return JSON.parse(cached);

    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheet = ss.getSheetByName("Analistas");
    if (!sheet) return [];

    const data = sheet.getDataRange().getValues();
    const activeAnalysts = [];

    // Pula header
    for (let i = 1; i < data.length; i++) {
        const nome = data[i][1];
        const email = data[i][2];
        const situacao = String(data[i][3]).toLowerCase();

        if (nome && email && (situacao.includes("atividade") || situacao.includes("normal") || situacao.includes("ativo"))) {
            activeAnalysts.push({
                name: toTitleCase(nome),
                email: String(email).toLowerCase()
            });
        }
    }

    // Cache de 1 hora
    cache.put("API_ANALISTAS_LITE", JSON.stringify(activeAnalysts), 3600);
    return activeAnalysts;
}

/**
 * v1.5.8: Armazena custódia do BitLocker e mantém status PENDENTE
 * Chamado pelo Daemon após sucesso na busca.
 */
function updateBitlockerCustody(payload) {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);

    // 1. Aba de Custódia (Segura, não synced BQ)
    let sheetKeys = ss.getSheetByName("Bitlocker");
    const expected = ["ID_SOLICITACAO", "DATA_AD", "FILIAL", "HOSTNAME_ID", "RECOVERY_KEY", "KEY_ID"];

    if (!sheetKeys) {
        sheetKeys = ss.insertSheet("Bitlocker");
        sheetKeys.appendRow(expected);
        sheetKeys.getRange(1, 1, 1, expected.length).setFontWeight("bold").setBackground("#e6b8af");
    }

    // Garante headers (Auto-Manage)
    if (sheetKeys.getLastRow() === 0) {
        sheetKeys.appendRow(expected);
    } else if (String(sheetKeys.getRange(1, 1).getValue()) !== "ID_SOLICITACAO") {
        sheetKeys.insertRowBefore(1);
        sheetKeys.getRange(1, 1, 1, expected.length).setValues([expected]);
    }

    // 2. Registra Chave
    sheetKeys.appendRow([
        String(payload.id).trim(),
        new Date(),
        payload.filial || "-",
        payload.hostname,
        payload.recoveryKey,
        payload.recoveryKeyId
    ]);

    // 3. Atualiza Fila Principal (Apenas Log, Status continua PENDENTE aguardando analista)
    const sheetFila = ss.getSheetByName("Solicitações");
    const data = sheetFila.getDataRange().getValues();
    const reqId = String(payload.id).trim();

    for (let i = 1; i < data.length; i++) {
        if (String(data[i][0]).trim() === reqId) {
            sheetFila.getRange(i + 1, 13).setValue("Chave localizada e enviada para custódia do analista.");
            break;
        }
    }
    return ContentService.createTextOutput("OK_CUSTODY").setMimeType(ContentService.MimeType.TEXT);
}

/**
 * v1.5.0: Finalização Manual pelo Analista (Link no Email)
 */
function finalizarAtendimentoBitlocker(id, analistaEmail) {
    const ss = SpreadsheetApp.openById(ID_PLANILHA_GESTAO);
    const sheet = ss.getSheetByName("Solicitações");
    const data = sheet.getDataRange().getValues();
    const reqId = String(id).trim(); // Conversão Explícita de Tipo

    for (let i = 1; i < data.length; i++) {
        // Comparação segura de String
        if (String(data[i][0]).trim() === reqId) {
            const row = i + 1;

            // Verifica se já não estava concluído
            if (String(data[i][9]).toUpperCase() === "CONCLUÍDO") {
                return HtmlService.createHtmlOutput(`
                    <div style="font-family: sans-serif; text-align: center; padding: 50px;">
                        <h2 style="color: #f59e0b;">⚠️ Atenção</h2>
                        <p>A solicitação <strong>${id}</strong> já havia sido finalizada anteriormente.</p>
                        <button onclick="window.close()" style="padding: 10px 20px; cursor: pointer;">Fechar</button>
                    </div>
                `);
            }

            sheet.getRange(row, 10).setValue("CONCLUÍDO"); // Status
            sheet.getRange(row, 13).setValue("Atendimento presencial realizado. Finalizado por: " + (analistaEmail || "Link Email"));

            // Log Auditoria Opcional (se tiver aba Auditoria)
            // ...

            return HtmlService.createHtmlOutput(`
                <div style="font-family: sans-serif; text-align: center; padding: 50px;">
                    <h2 style="color: #10b981;">✅ Atendimento Finalizado!</h2>
                    <p>A solicitação <strong>${id}</strong> foi marcada como CONCLUÍDA.</p>
                    <p>Obrigado, ${analistaEmail || 'Analista'}.</p>
                    <button onclick="window.close()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer;">Fechar Janela</button>
                </div>
            `);
        }
    }

    return HtmlService.createHtmlOutput(`
        <div style="font-family: sans-serif; text-align: center; padding: 50px;">
            <h2 style="color: #ef4444;">❌ Erro</h2>
            <p>Solicitação <strong>${id}</strong> não encontrada.</p>
        </div>
    `);
}

