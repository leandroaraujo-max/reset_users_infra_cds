<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reset de Usuários - Suporte Infra CDs</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --magalu-blue: #0086FF;
            --magalu-blue-dark: #0066CC;
            --magalu-blue-darker: #004499;
            --magalu-pink: #E91E76;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Rainbow Strip - Magalu Colors */
        .rainbow-strip {
            height: 4px;
            background: linear-gradient(90deg,
                    #E91E76 0%,
                    #FF5722 16%,
                    #FF9800 32%,
                    #4CAF50 48%,
                    #2196F3 64%,
                    #9C27B0 80%,
                    #E91E76 100%);
            background-size: 200% 100%;
            animation: rainbow-flow 8s linear infinite;
        }

        @keyframes rainbow-flow {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 200% 50%;
            }
        }

        /* Master Style v1.1.3 - Azul Magalu + Borda Degradê */
        .header-gradient {
            background-color: #0086FF !important;
            position: relative;
        }

        .header-gradient::after {
            content: "";
            position: absolute;
            bottom: 0px;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #0086FF 0%, #E91E76 50%, #FFC107 100%);
            z-index: 10;
        }

        /* Card Hover Effects */
        .card-hover {
            transition: all 0.2s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Status Badges - Enhanced */
        .badge-pending {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            color: #92400E;
            border: 1px solid #F59E0B;
        }

        .badge-success {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            color: #065F46;
            border: 1px solid #10B981;
        }

        .badge-error {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            color: #991B1B;
            border: 1px solid #EF4444;
        }

        /* Button Primary - Magalu Style */
        .btn-magalu {
            background: linear-gradient(135deg, var(--magalu-blue) 0%, var(--magalu-blue-dark) 100%);
            transition: all 0.2s ease;
        }

        .btn-magalu:hover {
            background: linear-gradient(135deg, var(--magalu-blue-dark) 0%, var(--magalu-blue-darker) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 134, 255, 0.4);
        }

        /* Input Focus - Enhanced */
        input:focus,
        select:focus {
            border-color: var(--magalu-blue) !important;
            box-shadow: 0 0 0 3px rgba(0, 134, 255, 0.15) !important;
        }

        /* Table Row Hover */
        .table-row-hover:hover {
            background-color: #EFF6FF !important;
        }

        /* Avatar Glow */
        .avatar-glow {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }

        /* Hide scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <div id="app" class="flex flex-col h-full">

        <div v-if="currentView === 'login'"
            class="flex min-h-full items-center justify-center py-12 px-4 sm:px-6 lg:px-8 h-full"
            style="background: linear-gradient(135deg, #004499 0%, #0066CC 50%, #0086FF 100%);">

            <!-- Rainbow Strip no topo -->
            <div class="rainbow-strip fixed top-0 left-0 right-0"></div>

            <div
                class="w-full max-w-md space-y-8 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl p-8 border border-white/20">
                <div class="text-center flex flex-col items-center">
                    <div class="p-2 mb-2">
                        <img :src="appLogo" alt="LuizaLabs" class="h-16 w-auto mx-auto drop-shadow-md">
                    </div>
                    <h2 class="mt-2 text-3xl font-bold tracking-tight text-gray-900">Gerenciamento de Usuários</h2>
                    <p class="text-sm font-medium text-blue-600">Suporte Infra CDs</p>
                    <p class="mt-4 text-sm text-gray-500">
                        Acesso exclusivo com conta Google corporativa
                    </p>
                </div>

                <div class="mt-8">
                    <button @click="handleLogin" :disabled="isLoading"
                        class="group relative flex w-full justify-center items-center gap-3 rounded-lg border border-gray-300 bg-white py-3 px-4 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 transition-all shadow-sm">

                        <svg class="h-5 w-5" aria-hidden="true" viewBox="0 0 24 24">
                            <path
                                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                                fill="#4285F4" />
                            <path
                                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                                fill="#34A853" />
                            <path
                                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                                fill="#FBBC05" />
                            <path
                                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                                fill="#EA4335" />
                        </svg>

                        {{ isLoading ? 'Autenticando...' : 'Entrar com Google' }}
                    </button>

                    <p v-if="authForm.errorMessage"
                        class="mt-4 text-center text-sm text-red-600 bg-red-50 p-2 rounded border border-red-100">
                        {{ authForm.errorMessage }}
                    </p>
                </div>

                <!-- Versão no canto inferior -->
                <div class="text-center text-xs text-gray-400 pt-4 border-t border-gray-100">
                    v1.5.3 • Leandro Araújo
                </div>
            </div>
        </div>

        <div v-if="currentView === 'app'" class="flex flex-col h-full">

            <header class="header-gradient text-white shadow-lg z-20 py-1 sm:py-0">
                <div
                    class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 min-h-[4rem] sm:h-20 flex flex-col sm:flex-row items-center justify-between py-2 sm:py-0 gap-2">
                    <div class="flex items-center justify-between w-full sm:w-auto">
                        <div class="flex items-center space-x-2 sm:space-x-3 cursor-pointer hover:opacity-80 transition-opacity"
                            @click="switchTab('new')">
                            <img :src="appLogo" alt="LuizaLabs" class="h-6 sm:h-8 w-auto filter brightness-0 invert">
                            <div class="leading-tight">
                                <div class="font-bold text-sm sm:text-xl tracking-tight">Gerenciamento de Usuários</div>
                                <div class="text-[10px] text-blue-200/80">Suporte Infra CDs</div>
                            </div>
                        </div>
                        <div class="flex sm:hidden items-center space-x-2">
                            <div class="h-8 w-8 rounded-full bg-white/20 flex items-center justify-center text-[10px] font-bold"
                                @click="logout">
                                {{ userInitials }}
                            </div>
                        </div>
                    </div>

                    <div class="w-full sm:w-auto overflow-x-auto no-scrollbar pb-1 sm:pb-0">
                        <div class="flex space-x-1 bg-white/10 rounded-lg p-1 min-w-max">
                            <button @click="switchTab('new')"
                                :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'new', 'text-white/80 hover:text-white': currentTab !== 'new'}"
                                class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                                Resets
                            </button>
                            <button @click="switchTab('mirror')"
                                :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'mirror', 'text-white/80 hover:text-white': currentTab !== 'mirror'}"
                                class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                                Espelhos
                            </button>
                            <button @click="switchTab('unlock')"
                                :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'unlock', 'text-white/80 hover:text-white': currentTab !== 'unlock'}"
                                class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                                Desbloqueios
                            </button>
                            <button @click="loadQueue"
                                :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'queue', 'text-white/80 hover:text-white': currentTab !== 'queue'}"
                                class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all">
                                Fila
                            </button>
                            <button @click="switchTab('bitlocker')"
                                :class="{'bg-white text-blue-700 shadow-sm': currentTab === 'bitlocker', 'text-white/80 hover:text-white': currentTab !== 'bitlocker'}"
                                class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-medium transition-all flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 001-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z"
                                        clip-rule="evenodd" />
                                </svg>
                                BitLocker
                            </button>
                        </div>
                    </div>

                    <div class="hidden sm:flex items-center space-x-4">
                        <div class="text-right">
                            <div class="text-[11px] font-medium opacity-90 leading-none mb-1">{{ userEmail }}</div>
                            <div class="text-[9px] text-white/60">Sessão Corporativa</div>
                        </div>
                        <div class="h-10 w-10 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center text-sm font-bold avatar-glow cursor-pointer hover:bg-white/30 transition-all"
                            @click="logout" title="Sair">
                            {{ userInitials }}
                        </div>
                    </div>
                </div>
            </header>
            <!-- Rainbow Strip (Removed for gold border style) -->


            <main class="flex-1 overflow-auto p-4 sm:p-6 lg:p-8">
                <div class="max-w-7xl mx-auto space-y-6">

                    <!-- ESPELHO DE ACESSO TAB -->
                    <div v-if="currentTab === 'mirror'" class="space-y-6">
                        <!-- PROGRESS BAR -->
                        <div class="flex items-center justify-center space-x-4 mb-8">
                            <div class="flex items-center">
                                <span :class="mirrorStep >= 1 ? 'bg-blue-600' : 'bg-gray-300'"
                                    class="flex items-center justify-center w-8 h-8 rounded-full text-white font-bold text-sm">1</span>
                                <span class="ml-2 text-sm font-medium"
                                    :class="mirrorStep >= 1 ? 'text-blue-600' : 'text-gray-500'">Modelo e Grupos</span>
                            </div>
                            <div class="w-16 h-0.5 bg-gray-200"></div>
                            <div class="flex items-center">
                                <span :class="mirrorStep >= 2 ? 'bg-blue-600' : 'bg-gray-300'"
                                    class="flex items-center justify-center w-8 h-8 rounded-full text-white font-bold text-sm">2</span>
                                <span class="ml-2 text-sm font-medium"
                                    :class="mirrorStep >= 2 ? 'text-blue-600' : 'text-gray-500'">Usuários Destino</span>
                            </div>
                        </div>

                        <!-- ETAPA 1: MODELO -->
                        <div v-if="mirrorStep === 1" class="space-y-6">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <h2 class="text-lg font-medium text-gray-900 mb-4">Etapa 1: Definir Usuário Modelo</h2>
                                <p class="text-sm text-gray-500 mb-6">Digite o <b>Usuário de Rede</b> de quem já possui
                                    os acessos.</p>

                                <div class="flex flex-col sm:flex-row gap-4 items-stretch sm:items-end">
                                    <div class="flex-1">
                                        <label
                                            class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Usuário
                                            Modelo</label>
                                        <input type="text" v-model="mirrorForm.modelUser"
                                            @keyup.enter="fetchMirrorGroups" placeholder="Ex: usuario_ad"
                                            class="block w-full px-3 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg border bg-white">
                                    </div>
                                    <button @click="fetchMirrorGroups"
                                        :disabled="mirrorLoading || !mirrorForm.modelUser"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center justify-center">
                                        {{ mirrorLoading ? 'Buscando...' : 'Listar Grupos' }}
                                    </button>
                                </div>
                                <div v-if="mirrorStatusMsg"
                                    class="mt-4 flex items-center justify-between bg-orange-50 border border-orange-100 rounded-lg p-3">
                                    <div class="text-sm text-orange-600 font-medium flex items-center gap-2">
                                        <svg class="animate-spin h-4 w-4 text-orange-600"
                                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor"
                                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                            </path>
                                        </svg>
                                        {{ mirrorStatusMsg }}
                                    </div>
                                    <button @click="cancelMirrorPoll"
                                        class="text-xs text-red-600 hover:text-red-800 font-bold underline">
                                        CANCELAR
                                    </button>
                                </div>
                            </div>

                            <div v-if="mirrorGroups.length > 0"
                                class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 animate-fade-in">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-md font-bold text-gray-800">Selecione os Grupos a Espelhar ({{
                                        mirrorGroups.length }})</h3>
                                    <div class="text-sm text-gray-500 space-x-2">
                                        <button @click="selectAllGroups(true)"
                                            class="text-blue-600 hover:underline">Marcar Todos</button>
                                        <span>|</span>
                                        <button @click="selectAllGroups(false)"
                                            class="text-blue-600 hover:underline">Desmarcar Todos</button>
                                    </div>
                                </div>
                                <div
                                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[300px] overflow-y-auto p-2 border border-gray-100 rounded-lg bg-gray-50">
                                    <label v-for="grp in mirrorGroups" :key="grp.name"
                                        class="flex items-start space-x-3 p-2 hover:bg-white rounded border border-transparent hover:border-gray-200 transition-all cursor-pointer">
                                        <input type="checkbox" v-model="grp.selected"
                                            class="mt-1 rounded border-gray-300 text-blue-600 h-4 w-4">
                                        <span class="text-xs text-gray-700 break-all">{{ grp.name }}</span>
                                    </label>
                                </div>
                                <div class="mt-6 flex justify-end">
                                    <button @click="mirrorStep = 2" :disabled="selectedGroupsCount === 0"
                                        class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-8 rounded-lg shadow-md disabled:opacity-50">
                                        Próxima Etapa: Selecionar Destinos →
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ETAPA 2: DESTINOS -->
                        <div v-if="mirrorStep === 2" class="space-y-6 animate-fade-in">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg font-medium text-gray-900">Etapa 2: Selecionar Usuários Destino
                                    </h2>
                                    <button @click="mirrorStep = 1" class="text-sm text-blue-600 hover:underline">←
                                        Voltar para grupos</button>
                                </div>
                                <p class="text-sm text-gray-500 mb-6">Busque e selecione os colaboradores que receberão
                                    os acessos.</p>

                                <div class="flex gap-4">
                                    <div class="flex-1 relative">
                                        <input type="text" v-model="mirrorSearchQuery"
                                            @keyup.enter="performMirrorSearch"
                                            placeholder="Busca Coringa: Nome, ID, Usuário ou E-mail..."
                                            class="block w-full pl-3 pr-10 py-2.5 border-gray-300 focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg border bg-white">
                                    </div>
                                    <button @click="performMirrorSearch" :disabled="mirrorSearchLoading"
                                        class="bg-gray-800 hover:bg-black text-white px-6 py-2.5 rounded-lg text-sm font-medium">
                                        {{ mirrorSearchLoading ? 'Buscando...' : 'Buscar' }}
                                    </button>
                                </div>

                                <!-- RESULTADOS BUSCA DESTINO (v1.1.2 Coringa) -->
                                <div v-if="mirrorSearchResults.length > 0"
                                    class="mt-6 border rounded-lg overflow-hidden bg-white shadow-sm">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase w-10">
                                                    <input type="checkbox"
                                                        @change="e => selectAllMirrorTargets(e.target.checked)"
                                                        :checked="allMirrorSelected"
                                                        class="rounded border-gray-300 text-blue-600 h-4 w-4"
                                                        title="Selecionar visíveis">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">
                                                    ID</th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">
                                                    Nome / Cargo</th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">
                                                    Usuário Rede</th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">
                                                    E-mail</th>
                                                <th
                                                    class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">
                                                    Centro de Custo</th>
                                            </tr>
                                            <!-- FILTROS DE COLUNA (ESPELHO) -->
                                            <tr class="bg-gray-50">
                                                <th class="px-2 py-1"></th>
                                                <th class="px-2 py-1"><input type="text" v-model="mirrorFilters.id"
                                                        placeholder="Filtrar ID"
                                                        class="w-11/12 text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                                </th>
                                                <th class="px-2 py-1"><input type="text" v-model="mirrorFilters.nome"
                                                        placeholder="Filtrar Nome"
                                                        class="w-11/12 text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                                </th>
                                                <th class="px-2 py-1"><input type="text"
                                                        v-model="mirrorFilters.user_name" placeholder="Filtrar User"
                                                        class="w-11/12 text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                                </th>
                                                <th class="px-2 py-1"><input type="text" v-model="mirrorFilters.email"
                                                        placeholder="Filtrar Email"
                                                        class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                                </th>
                                                <th class="px-2 py-1"><input type="text"
                                                        v-model="mirrorFilters.centro_custo" placeholder="Filtrar CC"
                                                        class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <tr v-for="u in filteredMirrorResults" :key="u.user_name"
                                                class="hover:bg-blue-50 transition-colors">
                                                <td class="px-4 py-3"><input type="checkbox" v-model="u.selected"
                                                        class="rounded border-gray-300 text-blue-600 h-4 w-4"></td>
                                                <td class="px-4 py-3 text-xs font-mono bg-gray-50">{{ u.id || '-' }}
                                                </td>
                                                <td class="px-4 py-3 text-xs">
                                                    <div class="font-bold text-gray-900">{{ toTitleCase(u.nome) }} - {{
                                                        toTitleCase(u.cargo) }}</div>
                                                </td>
                                                <td class="px-4 py-3 text-xs font-mono text-blue-700">{{ u.user_name }}
                                                </td>
                                                <td class="px-4 py-3 text-xs text-gray-600">{{ u.email ?
                                                    u.email.toLowerCase() : '-' }}</td>
                                                <td class="px-4 py-3 text-xs text-gray-500">{{ u.centro_custo }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- FINALIZAÇÃO -->
                            <div
                                class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col md:flex-row items-center justify-between gap-6">
                                <div class="flex-1">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Analista
                                        Responsável pelo Atendimento:</label>
                                    <select v-model="selectedAnalyst"
                                        class="w-full md:w-64 border-gray-300 rounded-lg p-2.5 bg-gray-50 focus:ring-blue-500">
                                        <option value="" disabled>Selecione o analista...</option>
                                        <option v-for="a in analystList" :key="a" :value="a">{{ a }}</option>
                                    </select>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-500 mb-2">
                                        <b>{{ selectedTargetsCount }}</b> destino(s) selecionado(s)
                                    </div>
                                    <button @click="submitMirrorFinal"
                                        :disabled="selectedTargetsCount === 0 || !selectedAnalyst || submitting"
                                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-xl shadow-lg transition-transform hover:scale-105 disabled:opacity-50">
                                        FINALIZAR E SOLICITAR ESPELHO
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DESBLOQUEIO DE USUÁRIO TAB -->
                    <div v-if="currentTab === 'unlock' || currentTab === 'new'" class="space-y-6">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6">
                            <div class="flex flex-col gap-4">
                                <div>
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">
                                        {{ searchLabel }}
                                    </label>
                                    <div class="flex flex-col sm:flex-row gap-2">
                                        <div class="relative flex-1">
                                            <div
                                                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24"
                                                    stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                                </svg>
                                            </div>
                                            <input type="text" v-model="searchQuery" @keyup.enter="performSearch"
                                                placeholder="Busca Coringa: Nome, ID, Usuário ou Email..."
                                                class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-9 text-sm border-gray-300 rounded-lg p-2.5 border bg-white shadow-sm">
                                        </div>
                                        <button @click="performSearch" :disabled="loading"
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg text-sm font-bold transition-all disabled:opacity-50 shadow-md flex items-center justify-center whitespace-nowrap">
                                            <svg v-if="loading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                                                fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                    stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor"
                                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                                </path>
                                            </svg>
                                            {{ loading ? 'Buscando...' : 'PESQUISAR' }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-if="hasResults" class="flex flex-wrap items-center justify-between gap-4 pb-2">
                            <div class="text-xs text-gray-400">Encontrados: {{ filteredResults.length }}</div>
                        </div>


                        <div
                            class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-h-[400px] flex flex-col">
                            <div v-if="!hasResults && !loading"
                                class="flex-1 flex flex-col items-center justify-center p-10 text-center text-gray-400">
                                <svg class="h-16 w-16 mb-4 text-gray-200" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                </svg>
                                <p v-if="hasSearched">Nenhum colaborador encontrado.</p>
                                <p v-else>Use os filtros acima para encontrar colaboradores.</p>
                            </div>

                            <div v-if="hasResults" class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
                                                <input type="checkbox" @change="toggleAll" :checked="allSelected"
                                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4">
                                            </th>
                                            <th scope="col" @click="sortResults('id')"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                                                ID
                                                <span v-if="resultSortColumn === 'id'" class="ml-1">{{
                                                    resultSortDirection === 'asc' ? '↑' : '↓' }}</span>
                                            </th>
                                            <th scope="col" @click="sortResults('nome')"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                                                Nome / Cargo
                                                <span v-if="resultSortColumn === 'nome'" class="ml-1">{{
                                                    resultSortDirection === 'asc' ? '↑' : '↓' }}</span>
                                            </th>
                                            <th scope="col" @click="sortResults('user_name')"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                                                Usuário Rede
                                                <span v-if="resultSortColumn === 'user_name'" class="ml-1">{{
                                                    resultSortDirection === 'asc' ? '↑' : '↓' }}</span>
                                            </th>
                                            <th scope="col" @click="sortResults('email')"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                                                Email
                                                <span v-if="resultSortColumn === 'email'" class="ml-1">{{
                                                    resultSortDirection === 'asc' ? '↑' : '↓' }}</span>
                                            </th>
                                            <th scope="col" @click="sortResults('centro_custo')"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">
                                                Centro de Custo
                                                <span v-if="resultSortColumn === 'centro_custo'" class="ml-1">{{
                                                    resultSortDirection === 'asc' ? '↑' : '↓' }}</span>
                                            </th>
                                        </tr>
                                        <!-- FILTROS DE COLUNA (Adjusted Width) -->
                                        <tr class="bg-gray-100">
                                            <th class="px-2 py-1"></th>
                                            <th class="px-2 py-1"><input type="text" v-model="searchFilters.id"
                                                    placeholder="Filtrar ID"
                                                    class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                            </th>
                                            <th class="px-2 py-1"><input type="text" v-model="searchFilters.nome"
                                                    placeholder="Filtrar Nome"
                                                    class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                            </th>
                                            <th class="px-2 py-1"><input type="text" v-model="searchFilters.user_name"
                                                    placeholder="Filtrar User"
                                                    class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                            </th>
                                            <th class="px-2 py-1"><input type="text" v-model="searchFilters.email"
                                                    placeholder="Filtrar Email"
                                                    class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                            </th>
                                            <th class="px-2 py-1"><input type="text"
                                                    v-model="searchFilters.centro_custo" placeholder="Filtrar CC"
                                                    class="w-full text-xs border-gray-300 rounded p-1 focus:ring-blue-500 font-normal">
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr v-for="user in filteredResults" :key="user.user_name"
                                            :class="{'bg-blue-50': user.selected, 'hover:bg-gray-50': !user.selected}"
                                            class="transition-colors text-xs">
                                            <td class="px-4 py-3 whitespace-nowrap"><input type="checkbox"
                                                    v-model="user.selected"
                                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4">
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <span class="text-xs font-mono bg-gray-100 px-2 py-0.5 rounded">{{
                                                    user.id || '-' }}</span>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <div>
                                                        <div class="font-medium text-gray-900">{{ toTitleCase(user.nome)
                                                            }}</div>
                                                        <div class="text-[10px] text-gray-500">{{
                                                            toTitleCase(user.cargo) }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <div
                                                    class="text-xs text-gray-900 font-mono bg-gray-100 px-2 py-0.5 rounded inline-block">
                                                    {{ user.user_name }}</div>
                                                <span v-if="user.ja_resetado"
                                                    class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-yellow-100 text-yellow-800">Já
                                                    Resetado</span>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">{{ user.email
                                                ? user.email.toLowerCase() : '-' }}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">{{
                                                user.centro_custo }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentTab === 'queue'"
                        class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <h2 class="text-lg font-medium text-gray-900">Últimas Solicitações</h2>
                            <button @click="loadQueue"
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                                <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Atualizar
                            </button>
                        </div>

                        <!-- Filtros da Fila -->
                        <div class="p-4 bg-gray-50 border-b border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase mb-1">Filial</label>
                                    <select v-model="queueFilters.filial"
                                        class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                        <option value="">Todas as Filiais</option>
                                        <option v-for="filial in uniqueQueueFilials" :key="filial" :value="filial">{{
                                            filial }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase mb-1">Status</label>
                                    <select v-model="queueFilters.status"
                                        class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                        <option value="">Todos os Status</option>
                                        <option value="PENDENTE">PENDENTE</option>
                                        <option value="SUCESSO">SUCESSO</option>
                                        <option value="ERRO">ERRO</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase mb-1">Analista</label>
                                    <select v-model="queueFilters.analista"
                                        class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                        <option value="">Todos os Analistas</option>
                                        <option v-for="analista in uniqueQueueAnalysts" :key="analista"
                                            :value="analista">{{ analista }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase mb-1">Buscar</label>
                                    <input type="text" v-model="queueFilters.search" placeholder="Nome ou usuário..."
                                        class="w-full text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                </div>
                            </div>
                        </div>

                        <div v-if="queueLoading" class="p-10 text-center text-gray-400">Carregando fila...</div>
                        <div v-else class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th @click="sortQueue('id')"
                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 w-16">
                                            ID
                                            <span v-if="sortColumn === 'id'" class="ml-1">{{ sortDirection === 'asc' ?
                                                '↑' : '↓' }}</span>
                                        </th>
                                        <th @click="sortQueue('data')"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Data
                                            <span v-if="sortColumn === 'data'" class="ml-1">{{ sortDirection === 'asc' ?
                                                '↑' : '↓' }}</span>
                                        </th>
                                        <th @click="sortQueue('filial')"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Filial
                                            <span v-if="sortColumn === 'filial'" class="ml-1">{{ sortDirection === 'asc'
                                                ? '↑' : '↓' }}</span>
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Usuário</th>
                                        <th @click="sortQueue('analista')"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Analista
                                            <span v-if="sortColumn === 'analista'" class="ml-1">{{ sortDirection ===
                                                'asc' ? '↑' : '↓' }}</span>
                                        </th>
                                        <th @click="sortQueue('tipo')"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Tipo
                                            <span v-if="sortColumn === 'tipo'" class="ml-1">{{ sortDirection ===
                                                'asc' ? '↑' : '↓' }}</span>
                                        </th>
                                        <th @click="sortQueue('status')"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Status
                                            <span v-if="sortColumn === 'status'" class="ml-1">{{ sortDirection === 'asc'
                                                ? '↑' : '↓' }}</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr v-for="item in paginatedQueue" :key="item.id || (item.data + item.user)"
                                        class="hover:bg-gray-50">
                                        <td
                                            class="px-4 py-4 whitespace-nowrap text-sm font-mono text-gray-600 bg-gray-50">
                                            #{{ item.id || '-' }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{
                                            formatDate(item.data) }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ item.filial }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900">{{ toTitleCase(item.nome) }}
                                            </div>
                                            <div class="text-xs text-gray-500">{{ item.user }}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.analista
                                            }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span :class="{
                                                    'bg-blue-100 text-blue-800': item.tipo === 'RESET' || item.tipo === 'RESET_SENHA',
                                                    'bg-green-100 text-green-800': item.tipo === 'UNLOCK' || item.tipo === 'DESBLOQUEIO_CONTA' || item.tipo === 'DESBLOQUEIO',
                                                    'bg-purple-100 text-purple-800': item.tipo === 'MIRROR' || item.tipo === 'ESPELHO_USUARIO'
                                                }"
                                                class="px-2 inline-flex text-[10px] leading-5 font-bold rounded-full border border-current opacity-80 uppercase tracking-tighter">
                                                {{ item.tipo || 'RESET' }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span
                                                :class="{'bg-yellow-100 text-yellow-800': item.status === 'PENDENTE', 'bg-green-100 text-green-800': item.status === 'SUCESSO', 'bg-red-100 text-red-800': item.status === 'ERRO'}"
                                                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">{{
                                                item.status }}</span>
                                        </td>
                                    </tr>
                                    <tr v-if="paginatedQueue.length === 0">
                                        <td colspan="6" class="px-6 py-10 text-center text-gray-400">Nenhum registro
                                            encontrado com os filtros selecionados.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginação -->
                        <div v-if="!queueLoading && filteredQueue.length > 0"
                            class="p-4 bg-gray-50 border-t border-gray-200 flex justify-center items-center">
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-widest">
                                Total Geral na Fila: {{ filteredQueue.length }} Colaboradores
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BITLOCKER TAB -->
                <div v-if="currentTab === 'bitlocker'" class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h2 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                            Recuperação de Chaves BitLocker
                        </h2>
                        <p class="text-sm text-gray-500 mb-6">Consulte a chave de recuperação (Recovery Key) de estações
                            de trabalho
                            consultando o Active Directory em tempo real. <!-- v1.5.3 Fix --> </p>

                        <div class="space-y-4">
                            <!-- Step 1: Requester Information -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
                                <div class="w-full">
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Solicitante
                                        (ID, Nome, Usuário ou Email)</label>
                                    <div class="flex gap-2">
                                        <input type="text" v-model="bitlockerUserId"
                                            @keyup.enter="fetchBitlockerUserInfo" placeholder="Busca inteligente..."
                                            class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                                        <button @click="fetchBitlockerUserInfo" :disabled="bitlockerSearchingUser"
                                            class="bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-all flex items-center">
                                            <svg v-if="bitlockerSearchingUser" class="animate-spin h-4 w-4" fill="none"
                                                viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                    stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor"
                                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                                </path>
                                            </svg>
                                            <svg v-else class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                            </svg>
                                        </button>
                                    </div>
                                    <div v-if="bitlockerUserFound"
                                        class="mt-2 p-2 bg-green-50 rounded border border-green-100 animate-fade-in">
                                        <p class="text-[10px] text-green-700 font-bold uppercase tracking-tight">
                                            ✅ {{ bitlockerUserFound.nome }}
                                        </p>
                                        <p class="text-[9px] text-green-600">
                                            {{ bitlockerUserFound.filial }} | {{ bitlockerUserFound.user_name }}
                                        </p>
                                    </div>
                                </div>
                                <div class="w-full">
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Hostname
                                        ou ID de Recuperação (8 dígitos)</label>
                                    <input type="text" v-model="bitlockerHostname"
                                        placeholder="Ex: W123ANX123RU ou 89107B05"
                                        class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500 uppercase">
                                    <p class="mt-1 text-[9px] text-gray-400">Insira o Hostname OU os 8 primeiros dígitos
                                        do ID da Senha.</p>
                                </div>
                            </div>

                            <!-- Step 2: Analyst Selection -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-6">
                                <div class="w-full">
                                    <label
                                        class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Analista
                                        que receberá a chave</label>
                                    <select v-model="bitlockerAnalyst"
                                        class="block w-full px-3 py-2.5 text-sm border-gray-300 rounded-lg border bg-white shadow-sm focus:ring-blue-500">
                                        <option value="" disabled>Selecione o Analista...</option>
                                        <option v-for="a in analystList" :key="a" :value="a">{{ a }}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex justify-end">
                                <button @click="requestBitlocker"
                                    :disabled="bitlockerLoading || !bitlockerHostname || !bitlockerAnalyst || !bitlockerUserId || bitlockerPasswordId.length < 8"
                                    class="w-full sm:w-auto bg-gray-800 hover:bg-black text-white px-10 py-3 rounded-xl text-sm font-bold transition-all disabled:opacity-50 shadow-lg flex items-center justify-center gap-2 transform hover:scale-105 active:scale-95">
                                    <svg v-if="bitlockerLoading" class="animate-spin h-5 w-5 text-white" fill="none"
                                        viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                    SOLICITAR RECUPERAÇÃO
                                </button>
                            </div>
                        </div>

                        <!-- Status Message -->
                        <div v-if="bitlockerLoading"
                            class="mt-6 flex items-center justify-center p-8 bg-gray-50 rounded-lg border border-gray-100 flex-col gap-3">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            <p class="text-sm text-gray-600">{{ bitlockerStatusMsg }}</p>
                            <p class="text-xs text-gray-400">Isso pode levar até 60 segundos.</p>
                        </div>

                        <!-- Result -->
                        <div v-if="bitlockerRes" class="mt-8 animate-fade-in">
                            <div class="border-l-4 border-green-500 bg-green-50 p-6 rounded-r-lg shadow-sm">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-lg font-bold text-green-800 mb-1">Chave Encontrada!</h3>
                                        <p class="text-sm text-green-700 mb-4">Hostname Identificado: <b>{{
                                                bitlockerRes.hostname
                                                }}</b></p>
                                    </div>
                                    <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded font-mono">{{
                                        bitlockerRes.passwordId ? 'ID: ' + bitlockerRes.passwordId.substring(0,8)
                                        + '...' : ''
                                        }}</span>
                                </div>

                                <div
                                    class="bg-white border border-green-100 rounded-lg p-4 mt-2 relative overflow-hidden group">
                                    <label class="block text-xs text-gray-400 uppercase tracking-widest mb-1">Recovery
                                        Key</label>
                                    <div
                                        class="font-mono text-2xl tracking-wider text-gray-800 break-all selection:bg-green-200">
                                        <span v-if="bitlockerShowKey">{{ bitlockerRes.recoveryKey }}</span>
                                        <span v-else
                                            class="text-gray-300 select-none">••••••-••••••-••••••-••••••-••••••-••••••-••••••-••••••</span>
                                    </div>

                                    <button @click="bitlockerShowKey = !bitlockerShowKey"
                                        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-full transition-all"
                                        title="Mostrar/Ocultar">
                                        <svg v-if="!bitlockerShowKey" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                        <svg v-else class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a10.059 10.059 0 013.999-5.325m2.597-1.626a9.006 9.006 0 014.288-1.049c4.478 0 8.268 2.943 9.542 7a10.06 10.06 0 01-1.093 3.03M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 3l18 18" />
                                        </svg>
                                    </button>
                                </div>
                                <p class="text-xs text-green-600 mt-2 text-right">⚠️ Confirme a identidade do
                                    solicitante antes de
                                    informar a chave.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <footer v-if="currentTab === 'new' || currentTab === 'unlock'"
                class="bg-white border-t border-gray-200 p-3 sm:p-4 shadow-lg-up z-20">
                <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="text-sm text-gray-500 order-2 sm:order-1">
                        <span v-if="selectedCount > 0" class="font-bold text-blue-600">{{ selectedCount }}</span>
                        selecionado(s).
                    </div>
                    <div class="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto order-1 sm:order-2">
                        <div class="w-full sm:w-auto">
                            <label
                                class="hidden sm:inline text-xs font-semibold text-gray-500 mr-2 uppercase">Analista:</label>
                            <select v-model="selectedAnalyst"
                                class="w-full sm:w-auto text-sm border-gray-300 rounded-md border p-2 focus:ring-blue-500 bg-gray-50">
                                <option value="" disabled>Selecione o Analista...</option>
                                <option v-for="a in analystList" :key="a" :value="a">{{ a }}</option>
                            </select>
                        </div>
                        <button @click="openConfirmModal"
                            :disabled="selectedCount === 0 || submitting || !selectedAnalyst"
                            class="w-full sm:w-auto bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white font-bold py-2.5 px-8 rounded-lg shadow-md transition-all">
                            {{ submitActionLabel }}
                        </button>
                    </div>
                </div>
            </footer>

            <div class="bg-gray-100 text-center py-2 text-xs text-gray-400 border-t border-gray-200">
                Leandro Araújo - Suporte Infra CDs
            </div>

            <div v-show="isConfirmModalVisible" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
                    <div
                        class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Confirmação</h3>
                        <div class="mt-4 text-left bg-gray-50 p-4 rounded-md border border-gray-200">
                            <p class="text-sm text-gray-600 mb-2">Solicitando reset para:</p>
                            <p class="text-2xl font-bold text-gray-900">{{ selectedCount }} colaboradores</p>
                            <p class="mt-2 text-sm text-gray-600">Analista: <b>{{ selectedAnalyst }}</b></p>
                        </div>
                        <div class="mt-5 sm:mt-6 flex flex-col-reverse sm:flex-row sm:gap-3">
                            <button @click="isConfirmModalVisible = false"
                                class="mt-3 sm:mt-0 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:text-sm">Cancelar</button>
                            <button @click="confirmAndSend"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:text-sm">Confirmar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="isSuccessModalVisible" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
                    <div
                        class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm sm:w-full sm:p-6">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                            <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-5">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Solicitação Enviada!</h3>
                            <button @click="downloadReceipt"
                                class="mt-4 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-blue-700 bg-blue-100 hover:bg-blue-200">Baixar
                                Comprovante</button>
                        </div>
                        <div class="mt-5 sm:mt-6">
                            <button @click="resetForm"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-gray-600 text-base font-medium text-white hover:bg-gray-700 sm:text-sm">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>



    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // ==========================================
                // CONFIGURAÇÃO DA LOGO
                // ==========================================
                // Cole o código Base64 da sua imagem (sem fundo) entre as aspas abaixo:
                const appLogo = "<?= LOGO_BASE64 ?>";
                // Exemplo: "data:image/png;base64,iVBORw0K..."

                // Auth State
                const currentView = ref('login');
                const isLoading = ref(false);
                const authForm = ref({ errorMessage: '' });


                // App State
                const currentTab = ref('new');
                const filiais = ref([]);
                const analystList = ref([]);
                const userEmail = ref('');
                const userInitials = ref('');
                const userName = ref('');
                const userFilial = ref('');
                const userCostCenter = ref('');
                const bitlockerHostname = ref('');
                const selectedFilial = ref('');
                const selectedAnalyst = ref('');
                const bitlockerAnalyst = ref('');
                const searchQuery = ref('');
                const searchResults = ref([]);
                const loading = ref(false);
                const submitting = ref(false);
                const isSuccessModalVisible = ref(false);
                const isConfirmModalVisible = ref(false);
                const lastRequestData = ref(null);
                const queueData = ref([]);
                const queueLoading = ref(false);
                const selectedCostCenter = ref('');

                // BitLocker v1.5.1 State
                const bitlockerUserId = ref('');
                const bitlockerPasswordId = ref('');
                const bitlockerUserFound = ref(null);
                const bitlockerSearchingUser = ref(false);

                // Mirror State
                const mirrorForm = ref({ modelUser: '' });
                const mirrorGroups = ref([]);
                const mirrorLoading = ref(false);
                const mirrorStatusMsg = ref('');
                const mirrorPollInterval = ref(null);

                // Estados para filtros e paginação da fila
                const queueFilters = ref({ filial: '', status: '', analista: '', search: '' });
                const currentPage = ref(1);
                const itemsPerPage = ref(25);
                const sortColumn = ref('data');
                const sortDirection = ref('desc');

                // Estados para ordenação dos resultados de busca
                const resultSortColumn = ref('nome');
                const resultSortDirection = ref('asc');

                // DATA FILTERS (v1.4.0)
                // DATA FILTERS (v1.4.0)
                console.log("Version 1.5.3 (BitLocker Refined) Loaded");
                const searchFilters = ref({ id: '', nome: '', user_name: '', email: '', centro_custo: '' });
                const mirrorFilters = ref({ id: '', nome: '', user_name: '', email: '', centro_custo: '' });

                const bitlockerLoading = ref(false);
                const bitlockerRes = ref(null);
                const bitlockerStatusMsg = ref('');
                const bitlockerShowKey = ref(false);
                const bitlockerPollInterval = ref(null);

                const rememberMe = ref(false);

                // --- AUTH METHODS ---
                const handleLogin = () => {
                    isLoading.value = true;
                    authForm.value.errorMessage = '';

                    google.script.run.withSuccessHandler(res => {
                        isLoading.value = false;
                        if (res.success) {
                            userEmail.value = res.token;
                            userInitials.value = res.name ? res.name.substring(0, 2).toUpperCase() : 'EU';
                            userName.value = res.name || '';
                            userFilial.value = res.filial || '';
                            userCostCenter.value = res.centro_custo || '';
                            initApp();
                        }
                    }).withFailureHandler(err => {
                        isLoading.value = false;
                        authForm.value.errorMessage = err.message;
                    }).loginWithGoogle();
                };

                // Auto-login if session persists (Optional optimization)
                onMounted(() => {
                    // We could trigger handleLogin() automatically if we wanted SSO-like experience
                    // handleLogin();
                    // But user explicitly asked for "Entrar com Google" button, so we wait for click.
                });

                const initApp = () => {
                    currentView.value = 'app';
                    google.script.run.withSuccessHandler(l => filiais.value = l).getFiliaisList();

                    // v1.5.0: Use Optimized API for Analysts
                    const handleAnalysts = (l) => {
                        if (l && l.length > 0 && typeof l[0] === 'object') {
                            analystObjects.value = l;
                            analystList.value = l.map(a => a.name).sort();
                        } else {
                            analystList.value = Array.isArray(l) ? l.sort() : [];
                        }
                    };

                    if (google.script.run.getAnalystsListAPI) {
                        google.script.run.withSuccessHandler(handleAnalysts).getAnalystsListAPI();
                    } else {
                        google.script.run.withSuccessHandler(handleAnalysts).getAnalystsList();
                    }
                };

                const logout = () => {
                    userEmail.value = '';
                    currentView.value = 'login';
                    authForm.value = { errorMessage: '' };
                };

                // --- APP METHODS ---
                const performSearch = () => {
                    if (!searchQuery.value) {
                        alert("Por favor, informe um termo de busca.");
                        return;
                    }
                    loading.value = true;
                    searchResults.value = [];
                    google.script.run.withSuccessHandler(res => {
                        searchResults.value = res.map(u => ({ ...u, selected: false }));
                        loading.value = false;
                    }).withFailureHandler(e => {
                        alert(e.message);
                        loading.value = false;
                    }).searchUserBQ(searchQuery.value);
                };

                // Função para ordenar resultados de busca
                const sortResults = (column) => {
                    if (resultSortColumn.value === column) {
                        resultSortDirection.value = resultSortDirection.value === 'asc' ? 'desc' : 'asc';
                    } else {
                        resultSortColumn.value = column;
                        resultSortDirection.value = 'asc';
                    }
                };

                const confirmAndSend = () => {
                    isConfirmModalVisible.value = false;
                    const selected = filteredResults.value.filter(u => u.selected); // Changed to filteredResults
                    submitting.value = true;
                    const taskType = currentTab.value === 'unlock' ? 'DESBLOQUEIO_CONTA' : 'RESET';
                    const data = {
                        users: selected,
                        analyst: selectedAnalyst.value,
                        requester: userEmail.value,
                        task_type: taskType
                    };
                    lastRequestData.value = data;
                    google.script.run.withSuccessHandler(() => {
                        submitting.value = false;
                        isSuccessModalVisible.value = true;
                        // O modal de sucesso já tem mensagem genérica, vamos manter, mas talvez atualizar o texto do modal no HTML se necessário. 
                        // Vou assumir que o alerta abaixo ou o modal é suficiente. O código original usava isSuccessModalVisible = true.
                        // Vamos adicionar um alert explicativo antes ou confiar no modal.
                        // O modal HTML deve ser ajustado. Como não vi o HTML do modal, vou manter apenas isSuccessModalVisible = true
                        // e adicionar um alert extra para garantir a comunicação clara se o modal não for explicativo o bastante.
                        alert("Solicitação enviada com sucesso! \n\nAssim que um analista aprovar via e-mail, o sistema processará seu pedido automaticamente.");

                        searchResults.value = [];
                        selectedFilial.value = '';
                        searchQuery.value = '';
                        selectedAnalyst.value = '';
                    }).withFailureHandler(e => {
                        submitting.value = false;
                        alert("Erro: " + e.message);
                    }).submitResetQueue(data);
                };

                // --- MIRROR METHODS ---
                const mirrorStep = ref(1);
                const mirrorSearchQuery = ref('');
                const mirrorSearchResults = ref([]);
                const mirrorSearchLoading = ref(false);

                const fetchMirrorGroups = () => {
                    if (!mirrorForm.value.modelUser) return;
                    mirrorLoading.value = true;
                    mirrorGroups.value = [];
                    mirrorStatusMsg.value = 'Iniciando solicitação ao agente...';

                    google.script.run.withSuccessHandler(res => {
                        if (res.success) {
                            pollMirrorStatus(res.requestId);
                        } else {
                            mirrorLoading.value = false;
                            alert('Erro ao iniciar: ' + res.message);
                        }
                    }).withFailureHandler(e => {
                        mirrorLoading.value = false;
                        alert('Falha: ' + e.message);
                    }).submitMirrorRequest(mirrorForm.value.modelUser, userEmail.value);
                };

                const pollMirrorStatus = (reqId) => {
                    let attempts = 0;
                    // Reduzido para 30 tentativas de 2s = 60 segundos
                    const maxAttempts = 30;
                    if (mirrorPollInterval.value) clearInterval(mirrorPollInterval.value);

                    mirrorPollInterval.value = setInterval(() => {
                        attempts++;
                        mirrorStatusMsg.value = `Aguardando grupos do AD... (${attempts * 2}s / ${maxAttempts * 2}s)`;

                        google.script.run.withSuccessHandler(res => {
                            if (res.status === 'CONCLUIDO') {
                                clearInterval(mirrorPollInterval.value);
                                mirrorLoading.value = false;
                                mirrorStatusMsg.value = '';
                                mirrorGroups.value = res.groups.map(g => ({ name: g, selected: true }));
                            } else if (res.status === 'ERRO') {
                                clearInterval(mirrorPollInterval.value);
                                mirrorLoading.value = false;
                                mirrorStatusMsg.value = '';
                                alert('Erro no AD: ' + res.message);
                            }
                        }).withFailureHandler(e => {
                            console.error("Poll Error:", e);
                            // Não para o polling por erro de rede pontual
                        }).checkMirrorStatus(reqId);

                        if (attempts >= maxAttempts) {
                            clearInterval(mirrorPollInterval.value);
                            mirrorLoading.value = false;
                            mirrorStatusMsg.value = '';
                            if (confirm('O tempo limite foi atingido. O agente local pode estar offline. Deseja tentar novamente?')) {
                                fetchMirrorGroups();
                            }
                        }
                    }, 2000);
                };

                const cancelMirrorPoll = () => {
                    if (mirrorPollInterval.value) clearInterval(mirrorPollInterval.value);
                    mirrorLoading.value = false;
                    mirrorStatusMsg.value = '';
                };

                const performMirrorSearch = () => {
                    if (!mirrorSearchQuery.value) return;
                    mirrorSearchLoading.value = true;
                    google.script.run.withSuccessHandler(res => {
                        mirrorSearchResults.value = res.map(u => ({ ...u, selected: false }));
                        mirrorSearchLoading.value = false;
                    }).withFailureHandler(e => {
                        mirrorSearchLoading.value = false;
                        alert(e.message);
                    }).searchUserBQ(mirrorSearchQuery.value);
                };

                const selectAllGroups = (val) => {
                    mirrorGroups.value.forEach(g => g.selected = val);
                };

                // NEW: Select All Visible Targets (Mirror)
                const selectAllMirrorTargets = (val) => {
                    filteredMirrorResults.value.forEach(u => u.selected = val);
                };

                const selectedGroupsCount = computed(() => mirrorGroups.value.filter(g => g.selected).length);
                const selectedTargetsCount = computed(() => filteredMirrorResults.value.filter(u => u.selected).length); // Use Filtered

                const submitMirrorFinal = () => {
                    // FIX v1.3.6: Envia objetos completos para popular colunas nas Solicitações
                    // CHANGE v1.4.0: Use filteredMirrorResults instead of full list to respect user filters? Or just check selected?
                    // Usually we only send SELECTED users. The filter is just for VIEW/SELECTION.
                    // But 'selectAllMirrorTargets' only selects VISIBLE ones.
                    // So we iterate over mirrorSearchResults (the full list) and pick selected ones.
                    const targets = mirrorSearchResults.value.filter(u => u.selected).map(u => ({
                        user_name: u.user_name,
                        nome: u.nome,
                        email: u.email,
                        centro_custo: u.centro_custo,
                        filial: u.filial // CORREÇÃO v1.4.1: Enviar Filial real
                    }));
                    const groups = mirrorGroups.value.filter(g => g.selected).map(g => g.name);

                    if (targets.length === 0) return alert("Selecione ao menos um usuário de destino.");
                    if (!selectedAnalyst.value) return alert("Selecione um analista responsável.");

                    submitting.value = true;
                    google.script.run.withSuccessHandler(res => {
                        submitting.value = false;
                        alert("Solicitação de espelhamento enviada para APROVAÇÃO TÉCNICA! \n\nO analista selecionado foi notificado para validar a requisição. O processamento ocorrerá automaticamente após a aprovação.");
                        resetMirror();
                    }).withFailureHandler(e => {
                        submitting.value = false;
                        alert("Erro ao enviar: " + e.message);
                    }).submitMirrorExecution({
                        modelUser: mirrorForm.value.modelUser,
                        groups: groups,
                        targets: targets,
                        analyst: selectedAnalyst.value,
                        requester: userEmail.value
                    });
                };

                const resetMirror = () => {
                    mirrorStep.value = 1;
                    mirrorForm.value.modelUser = '';
                    mirrorGroups.value = [];
                    mirrorSearchResults.value = [];
                    mirrorSearchQuery.value = '';
                    mirrorFilters.value = { id: '', nome: '', user_name: '', email: '', centro_custo: '' }; // Reset filters
                    currentTab.value = 'queue';
                    loadQueue();
                };

                // --- BITLOCKER METHODS ---
                // --- BITLOCKER METHODS ---
                const analystObjects = ref([]); // Store {name, email}

                const fetchBitlockerUserInfo = () => {
                    if (!bitlockerUserId.value) return;
                    bitlockerSearchingUser.value = true;
                    bitlockerUserFound.value = null;
                    google.script.run.withSuccessHandler(res => {
                        bitlockerSearchingUser.value = false;
                        if (res && res.length > 0) {
                            bitlockerUserFound.value = res[0];
                        } else {
                            alert("Colaborador não encontrado com o termo informado.");
                        }
                    }).withFailureHandler(e => {
                        bitlockerSearchingUser.value = false;
                        alert("Erro ao buscar colaborador: " + e.message);
                    }).searchUserBQ(bitlockerUserId.value);
                };

                const requestBitlocker = () => {
                    if (!bitlockerHostname.value || !bitlockerAnalyst.value || !bitlockerUserFound.value) {
                        return alert('Preencha o solicitante, o hostname/ID e o analista.');
                    }

                    // Se o valor tiver 8 caracteres e for alfanumérico sem caracteres especiais, 
                    // tratamos como PasswordID. Se não, como Hostname vindo do AD.
                    // O Daemon fará a inteligência final.
                    let finalHostname = bitlockerHostname.value.trim().toUpperCase();
                    let finalPasswordId = "";

                    if (finalHostname.length === 8 && /^[A-Z0-9]+$/.test(finalHostname)) {
                        finalPasswordId = finalHostname; // Provável ID de Senha
                    }

                    // Find Analyst Email
                    const selectedObj = analystObjects.value.find(a => a.name === bitlockerAnalyst.value);
                    const analystEmail = selectedObj ? selectedObj.email : bitlockerAnalyst.value;

                    bitlockerLoading.value = true;
                    bitlockerRes.value = null;
                    bitlockerStatusMsg.value = "Enviando solicitação para o Agente AD...";

                    google.script.run
                        .withSuccessHandler((response) => {
                            bitlockerLoading.value = false;
                            if (response.success) {
                                bitlockerStatusMsg.value = "";
                                alert(`Solicitação #${response.requestId} registrada! \n\nA chave será enviada por e-mail para ${bitlockerAnalyst.value}.`);
                                // Reset fields
                                bitlockerHostname.value = "";
                                bitlockerUserId.value = "";
                                bitlockerUserFound.value = null;
                            } else {
                                alert("Erro: " + response.message);
                            }
                        })
                        .withFailureHandler((err) => {
                            bitlockerLoading.value = false;
                            alert("Erro de comunicação: " + err.message);
                        })
                        .submitBitlockerRequest({
                            hostname: finalHostname,
                            passwordId: finalPasswordId,
                            analyst: bitlockerAnalyst.value,
                            analystEmail: analystEmail,
                            requester: userEmail.value,
                            userData: bitlockerUserFound.value
                        });
                };

                // Removed pollBitlocker as Key is not returned to Frontend anymore.


                const switchTab = (tabName) => {
                    console.log("Switching tab to:", tabName);
                    currentTab.value = tabName;
                };

                const loadQueue = () => {
                    switchTab('queue');
                    queueLoading.value = true;
                    google.script.run.withSuccessHandler(res => {
                        queueData.value = res;
                        queueLoading.value = false;
                    }).withFailureHandler(e => queueLoading.value = false).getQueueWeb();
                };

                // --- DOWNLOAD CSV (Lógica Real) ---
                const downloadReceipt = () => {
                    // 1. Validar se tem dados
                    if (!lastRequestData.value || !lastRequestData.value.users) {
                        alert("Nenhum dado para exportar.");
                        return;
                    }

                    const request = lastRequestData.value;
                    const timestamp = new Date().toLocaleString('pt-BR');

                    // 2. Cabeçalho do CSV
                    let csvContent = "Data;Filial;Nome Colaborador;Usuario Rede;Email;Centro Custo;Analista Responsavel;Solicitante\n";

                    // 3. Iterar sobre os usuários e montar as linhas
                    request.users.forEach(user => {
                        const row = [
                            timestamp,
                            request.filial,
                            user.nome,
                            user.user_name,
                            user.email || "-",
                            user.centro_custo,
                            request.analyst,
                            request.requester
                        ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(";"); // Escape de aspas e uso de ; para Excel BR

                        csvContent += row + "\n";
                    });

                    // 4. Criar o Blob com BOM para acentuação funcionar no Excel
                    const bom = "\uFEFF";
                    const blob = new Blob([bom + csvContent], { type: "text/csv;charset=utf-8;" });

                    // 5. Criar link invisível e clicar
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `Comprovante_Reset_${Date.now()}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                // Helpers
                const toTitleCase = (str) => String(str).replace(/_/g, ' ').toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

                const formatDate = (d) => {
                    if (!d) return '-';
                    const dateObj = new Date(d);
                    if (isNaN(dateObj.getTime())) return String(d);
                    return dateObj.toLocaleString('pt-BR', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                };

                const toggleAll = () => { const s = !allSelected.value; filteredResults.value.forEach(u => u.selected = s); };
                const openConfirmModal = () => isConfirmModalVisible.value = true;
                const resetForm = () => { isSuccessModalVisible.value = false; searchResults.value = []; currentTab.value = 'queue'; loadQueue(); };

                // Métodos de ordenação e paginação
                const sortQueue = (column) => {
                    if (sortColumn.value === column) {
                        sortDirection.value = sortDirection.value === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn.value = column;
                        sortDirection.value = 'desc';
                    }
                };

                const changePage = (page) => {
                    // Sem limites! Mas mantemos a lógica de página se quiserem usar, 
                    // porém por padrão exibimos todos.
                    if (page >= 1 && page <= totalPages.value) {
                        currentPage.value = page;
                    }
                };

                // Removemos o limite da fila para v1.1.3
                onMounted(() => {
                    itemsPerPage.value = 5000;
                });

                // Computed
                const uniqueCostCenters = computed(() => [...new Set(searchResults.value.map(u => u.centro_custo))].sort());

                // FILTER LOGIC (v1.4.0)
                const filterList = (list, filters, sortCol, sortDir) => {
                    let res = list;
                    // Column Filters
                    if (filters.id) res = res.filter(u => String(u.id || '').toLowerCase().includes(filters.id.toLowerCase()));
                    if (filters.nome) res = res.filter(u => (String(u.nome || '') + ' ' + String(u.cargo || '')).toLowerCase().includes(filters.nome.toLowerCase()));
                    if (filters.user_name) res = res.filter(u => String(u.user_name || '').toLowerCase().includes(filters.user_name.toLowerCase()));
                    if (filters.email) res = res.filter(u => String(u.email || '').toLowerCase().includes(filters.email.toLowerCase()));
                    if (filters.centro_custo) res = res.filter(u => String(u.centro_custo || '').toLowerCase().includes(filters.centro_custo.toLowerCase()));

                    // Sort
                    return [...res].sort((a, b) => {
                        let aVal = a[sortCol];
                        let bVal = b[sortCol];
                        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                        const direction = sortDir === 'asc' ? 1 : -1;
                        if (aVal > bVal) return direction;
                        if (aVal < bVal) return -direction;
                        return 0;
                    });
                };

                const filteredResults = computed(() => {
                    // Apply column filters
                    // REMOVED: selectedCostCenter (Quick Filter)
                    let results = searchResults.value;
                    return filterList(results, searchFilters.value, resultSortColumn.value, resultSortDirection.value);
                });

                const filteredMirrorResults = computed(() => {
                    return filterList(mirrorSearchResults.value, mirrorFilters.value, 'nome', 'asc');
                });

                const hasResults = computed(() => searchResults.value.length > 0);
                const selectedCount = computed(() => filteredResults.value.filter(u => u.selected).length); // Use filtered
                const allSelected = computed(() => filteredResults.value.length > 0 && filteredResults.value.every(u => u.selected));
                const allMirrorSelected = computed(() => filteredMirrorResults.value.length > 0 && filteredMirrorResults.value.every(u => u.selected));

                // Computed properties para filtros da fila
                const uniqueQueueFilials = computed(() => [...new Set(queueData.value.map(item => item.filial))].sort());
                const uniqueQueueAnalysts = computed(() => [...new Set(queueData.value.map(item => item.analista))].filter(a => a).sort());

                const filteredQueue = computed(() => {
                    let filtered = queueData.value;

                    // Filtro por filial
                    if (queueFilters.value.filial) {
                        filtered = filtered.filter(item => item.filial === queueFilters.value.filial);
                    }

                    // Filtro por status
                    if (queueFilters.value.status) {
                        filtered = filtered.filter(item => item.status === queueFilters.value.status);
                    }

                    // Filtro por analista
                    if (queueFilters.value.analista) {
                        filtered = filtered.filter(item => item.analista === queueFilters.value.analista);
                    }

                    // Busca por nome/usuário
                    if (queueFilters.value.search) {
                        const search = queueFilters.value.search.toLowerCase();
                        filtered = filtered.filter(item =>
                            (item.nome && item.nome.toLowerCase().includes(search)) ||
                            (item.user && item.user.toLowerCase().includes(search))
                        );
                    }

                    // Ordenação
                    filtered = [...filtered].sort((a, b) => {
                        let aVal = a[sortColumn.value];
                        let bVal = b[sortColumn.value];

                        // Tratamento especial para datas
                        if (sortColumn.value === 'data') {
                            aVal = new Date(aVal).getTime() || 0;
                            bVal = new Date(bVal).getTime() || 0;
                        }

                        const direction = sortDirection.value === 'asc' ? 1 : -1;
                        if (aVal > bVal) return direction;
                        if (aVal < bVal) return -direction;
                        return 0;
                    });

                    return filtered;
                });

                const paginatedQueue = computed(() => {
                    const start = (currentPage.value - 1) * itemsPerPage.value;
                    const end = start + itemsPerPage.value;
                    return filteredQueue.value.slice(start, end);
                });

                const totalPages = computed(() => Math.ceil(filteredQueue.value.length / itemsPerPage.value) || 1);

                const searchLabel = computed(() => currentTab.value === 'new' ? 'Busca para Reset de Senha' : 'Busca para Desbloqueio de Conta');
                const submitActionLabel = computed(() => {
                    if (submitting.value) return 'Enviando...';
                    return currentTab.value === 'new' ? 'SOLICITAR RESET' : 'SOLICITAR DESBLOQUEIO';
                });

                return {
                    appLogo,
                    currentView, authForm, isLoading, userEmail, userInitials, rememberMe,
                    handleLogin, logout,
                    currentTab, filiais, analystList, selectedFilial, selectedAnalyst, searchQuery,
                    searchResults, loading, submitting, isConfirmModalVisible, isSuccessModalVisible,
                    queueData, queueLoading, performSearch, confirmAndSend, loadQueue,

                    // Utils & Filters
                    selectedCostCenter, uniqueCostCenters, filteredResults, hasResults, selectedCount, allSelected,
                    toggleAll, openConfirmModal, resetForm, downloadReceipt, toTitleCase, formatDate,
                    searchFilters, mirrorFilters, filterList,

                    // Bitlocker
                    bitlockerHostname, bitlockerUserId, bitlockerUserFound, bitlockerSearchingUser, bitlockerAnalyst,
                    bitlockerLoading, bitlockerRes, bitlockerStatusMsg, bitlockerShowKey, fetchBitlockerUserInfo, requestBitlocker,

                    // Mirror
                    mirrorStep, mirrorForm, mirrorGroups, mirrorLoading, mirrorStatusMsg, fetchMirrorGroups,
                    cancelMirrorPoll, mirrorSearchQuery, mirrorSearchResults, mirrorSearchLoading, performMirrorSearch,
                    selectedGroupsCount, selectAllGroups, selectAllMirrorTargets, selectedTargetsCount, submitMirrorFinal, resetMirror,
                    filteredMirrorResults, allMirrorSelected, switchTab,

                    // Ordenação e Paginação
                    sortQueue, sortColumn, sortDirection, queueFilters, uniqueQueueFilials, uniqueQueueAnalysts, itemsPerPage, currentPage, totalPages, paginatedQueue, changePage,
                    resultSortColumn, resultSortDirection, sortResults, filteredQueue,

                    // Labels
                    searchLabel, submitActionLabel
                };
            }
        }).mount('#app');
    </script>
</body>

</html>